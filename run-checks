#!/bin/sh

set -eu

if which goctest >/dev/null; then
    goctest="goctest"
else
    goctest="go test"
fi

STATIC=""
UNIT=""
INTEGRATION=""

case "${1:-all}" in
    all)
        STATIC="yes"
        UNIT="yes"
        INTEGRATION="yes"
        ;;
    --static)
        STATIC="yes"
        ;;
    --unit)
        UNIT="yes"
        ;;
    --integration)
        INTEGRATION="yes"
        ;;
    *)
        echo "Wrong flag ${1}. To run a single suite use --static, --unit or --integration."
        exit 1
esac

endmsg() {
    if [ $? -eq 0 ]; then
        p="success.txt"
        m="All good, what could possibly go wrong."
    else
        p="failure.txt"
        m="Crushing failure and despair."
    fi
    echo
    if [ -t 1 -a -z "$STATIC" ]; then
        cat "data/$p"
    else
        echo "$m"
    fi
}
trap endmsg EXIT

# Append the coverage profile of a package to the project coverage.
append_coverage() {
    local profile="$1"
    if [ -f $profile ]; then
        cat $profile | grep -v "mode: set" >> .coverage/coverage.out
        rm $profile
    fi
}

if [ ! -z "$STATIC" ]; then
    # Run static tests.
    echo Checking docs
    ./mdlint.py docs/*.md

    echo Checking formatting
    fmt=$(gofmt -l .)

    if [ -n "$fmt" ]; then
        echo "Formatting wrong in following files"
        echo "$fmt"
        exit 1
    fi

    # go vet
    echo Running vet
    go vet ./...
    go vet -tags=integration ./...

    # golint
    echo Install golint
    go get github.com/golang/lint/golint
    export PATH=$PATH:$GOPATH/bin

    echo Running lint
    lint=$(golint ./... && golint ./integration-tests/testutils/... && golint ./integration-tests/tests/...)
    if [ -n "$lint" ]; then
        echo "Lint complains:"
        echo "$lint"
        exit 1
    fi

    (
        # pot file
        echo Checking translations
        TMPF="$(mktemp)"
        trap "rm -f $TMPF" 0
        ./update-pot "$TMPF"
        if ! diff -u --ignore-matching-lines=.*POT-Creation-Date.* po/snappy.pot $TMPF; then
            echo "You need to run ./update-pot"
            exit 1
        fi
        # This is a subshell so we don't overwrite the all-important outer trap.
    )

fi

if [ ! -z "$UNIT" ]; then
    # Prepare the coverage output profile.
    rm -rf .coverage
    mkdir .coverage
    echo "mode: set" > .coverage/coverage.out

    echo Installing godeps
    go get launchpad.net/godeps
    export PATH=$PATH:$GOPATH/bin

    echo Obtaining dependencies
    godeps -u dependencies.tsv

    echo Building
    go build -v github.com/ubuntu-core/snappy/...

    # tests
    echo Running tests from $(pwd)
    for pkg in $(go list ./...); do
        $goctest -v -coverprofile=.coverage/profile.out $pkg
        append_coverage .coverage/profile.out
    done

    # the rabbit hole
    echo Running the tests for the integration testutils
    # go list doesn't take into account build tags
    for pkg in $(ls ./integration-tests/testutils/); do
        $goctest -tags=integration -v -coverprofile=.coverage/profile.out "github.com/ubuntu-core/snappy/integration-tests/testutils/$pkg"
        append_coverage .coverage/profile.out
    done
fi

if [ ! -z "$INTEGRATION" ]; then
    # integration tests
    echo Building the integration tests
    go build -tags=integration integration-tests/main.go

    # integration suite in kvm
    if which adt-run >/dev/null 2>&1; then
        echo "Running integration tests on rolling edge"
        go run -tags=integration integration-tests/main.go --snappy-from-branch
        # print the results.
        if which subunit2pyunit >/dev/null 2>&1; then
            subunit-1to2 /tmp/snappy-test/output/artifacts/results.subunit | subunit2pyunit
        fi
    fi
fi
