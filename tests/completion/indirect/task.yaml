summary: indirect completion

environment:
    SNAP_DIR: "${TESTSLIB}/snaps/test-snapd-complexion"

prepare: |
    . "${TESTSLIB}/snaps.sh"
    install_local test-snapd-complexion

    mv "${SNAP_DIR}/test-snapd-complexion.bash-completer" "${SNAP_DIR}/test-snapd-complexion.bash-completer.orig"
    cp "${SPREAD_PATH}/${SPREAD_SUITE}/${SPREAD_VARIANT}.complete" "${SNAP_DIR}/test-snapd-complexion.bash-completer"
    snap alias test-snapd-complexion cplx
    snap alias test-snapd-complexion.two cplx2

restore: |
    mv "${SNAP_DIR}/test-snapd-complexion.bash-completer.orig" "${SNAP_DIR}/test-snapd-complexion.bash-completer"
    snap remove test-snapd-complexion

execute: |
  d="$PWD"
  source "${SPREAD_PATH}/${SPREAD_SUITE}/${SPREAD_VARIANT}.vars"
  export _OUT0 _OUT1 _OUT2 _KEY1 _KEY2 _COMP
  for c in test-snapd-complexion test-snapd-complexion.two cplx cplx2; do
    sudo CMD=$c PATH=$PATH _COMPLETE_SH=true -E -u test expect -d -f "$d"/task.exp
    sudo CMD=$c PATH=$PATH _COMPLETE_SH=false -E -u test expect -d -f "$d"/task.exp
  done
