summary: execute all the spread tests in a nested Ubuntu Core VM

details: |
    Verify that it is possible to run the full test suite in ubuntu core system
    using a nested vm. The test can be used to validate specific pre-built images.

backends: [openstack-ext, openstack-validation]

systems: [ubuntu-*]

manual: true

warn-timeout: 3m
kill-timeout: 8h

environment:
    TESTS/smoke: "tests/smoke/"
    NESTED_BUILD_SNAPD_FROM_CURRENT/smoke: true
    TESTS/custom: ""
    NESTED_BUILD_SNAPD_FROM_CURRENT/custom: false

artifacts: 
    - spread.log

prepare: |
    tests.nested build-image core
    tests.nested create-vm core

execute: |
    SPREAD="$(tests.nested download spread)"

    # Get the nested system to use
    NESTED_SPREAD_SYSTEM="$(tests.nested nested-system)"

    set +x
    export SPREAD_EXTERNAL_ADDRESS=localhost:8022
    export SPREAD_HTTP_PROXY="$HTTP_PROXY"
    export SPREAD_HTTPS_PROXY="$HTTPS_PROXY"
    export SPREAD_NO_PROXY="$NO_PROXY"
    export SPREAD_SNAPD_USE_PROXY="$SNAPD_USE_PROXY"

    RUN_TESTS="external:$NESTED_SPREAD_SYSTEM:$TESTS"
    if [ "$SPREAD_VARIANT" = "custom" ]; then
        if [ -z "$NESTED_SPREAD_TESTS" ]; then
            echo "When using the custom variant, it is required to set the NESTED_SPREAD_TESTS env var"
            exit 1
        fi
        RUN_TESTS="$NESTED_SPREAD_TESTS"
        remote.refresh full
    fi

    echo "Running $SPREAD $RUN_TESTS"
    (
        set -o pipefail
        # shellcheck disable=SC2086
        "$SPREAD" $RUN_TESTS | tee spread.log
    )
