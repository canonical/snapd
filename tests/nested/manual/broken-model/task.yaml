summary: Verifies that changing the model prevents unlocking of encrypted disks
details: |
  Verifies that changing the model prevents unlocking of encrypted
  disks.  However, recovery keys can still unlock them.

systems: [ubuntu-2*]

environment:
  NESTED_ENABLE_TPM/tpm: true
  NESTED_ENABLE_SECURE_BOOT/tpm: true
  BUILD_FDE_HOOK/tpm: '0'
  NESTED_ENABLE_TPM/hook: false
  NESTED_ENABLE_SECURE_BOOT/hook: false
  BUILD_FDE_HOOK/hook: '1'

prepare: |
  if [ "${BUILD_FDE_HOOK-}" = 1 ]; then
    mkdir -p ./extra-initrd/usr/bin/
    go build -o ./extra-initrd/usr/bin/fde-reveal-key "${TESTSLIB}/fde-setup-hook/fde-setup.go"
    mkdir -p ./extra-kernel-snap/meta/hooks
    go build -o ./extra-kernel-snap/meta/hooks/fde-setup "${TESTSLIB}/fde-setup-hook/fde-setup.go"
  fi

  tests.nested build-image core
  tests.nested create-vm core

execute: |
  remote.exec "sudo sed -i 's/^brand-id: .*/brand-id: foobar/;s/^authority-id: .*/authority-id: foobar/' /run/mnt/ubuntu-boot/device/model"
  tests.nested vm set-recovery-key "$(remote.exec "sudo snap recovery --show-keys" | sed 's/^recovery: *//')"

  boot_id="$(tests.nested boot-id)"
  tests.nested vm stop
  tests.nested vm start
  remote.wait-for reboot "$boot_id"

  remote.exec "sudo snap debug api /v2/system-info/storage-encrypted 2>/dev/null"  | gojq '.result.status' | MATCH "recovery"
