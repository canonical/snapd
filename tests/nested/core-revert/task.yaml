summary: core revert test

systems: [ubuntu-16.04-64]

prepare: |
    . $TESTSLIB/nested.sh
    create_nested_core_vm

restore: |
    . $TESTSLIB/nested.sh
    destroy_nested_core_vm

execute: |
    . $TESTSLIB/nested.sh

    cd $SPREAD_PATH
    execute_remote "sudo snap install network-manager"
    execute_remote "snap info core" | MATCH "tracking: +${CORE_CHANNEL}"
    execute_remote "sudo snap refresh --${CORE_REFRESH_CHANNEL} core" || true
    wait_for_ssh
    while ! execute_remote "snap changes" | MATCH "Done.*Refresh \"core\" snap from \"${CORE_REFRESH_CHANNEL}\" channel"; do sleep 1 ; done
    execute_remote "snap info core" | MATCH "tracking: +${CORE_REFRESH_CHANNEL}"
    execute_remote "sudo snap refresh"
    execute_remote "sudo snap revert core" || true
    wait_for_ssh
    while ! execute_remote "snap changes" | MATCH "Done.*Revert \"core\" snap"; do sleep 1 ; done
    execute_remote "snap info core" | MATCH "tracking: +${CORE_REFRESH_CHANNEL}"
    execute_remote "ifconfig" | MATCH eth0
    execute_remote "sudo snap refresh"
