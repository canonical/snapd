summary: Run a smoke test on UC with encryption enabled

details: |
    This test checks basic snapd commands on UC with secure boot and encryption enabled

systems: [ubuntu-20.04-64, ubuntu-22.04-64]

execute: |
    echo "Wait for the system to be seeded first"
    tests.nested exec "sudo snap wait system seed.loaded"

    echo "Ensuring the presence of ubuntu-save"
    tests.nested exec "lsblk -f -m -l | awk '{ print \$3 }' | grep ubuntu-save"

    echo "Ensuring the path /var/lib/snapd/save exists"
    tests.nested exec "ls -l /var/lib/snapd/save"

    # Build our local version of snapd-sh that contains the .cmd file
    SNAP_FILE=$("$TESTSTOOLS"/snaps-state pack-local test-snapd-sh "$TESTSLIB"/snaps/test-snapd-sh)
    tests.nested copy "$SNAP_FILE"

    # next up is to install a snap and verify the creation of a snap save folder
    # for that snap on the ubuntu-save partition
    tests.nested exec "sudo snap install test-snapd-sh"

    echo "Ensuring the path /var/lib/snapd/save/snap now exists"
    tests.nested exec "ls -l /var/lib/snapd/save/snap"

    echo "Ensuring the path /var/lib/snapd/save/snap/test-snapd-sh now exists"
    tests.nested exec "ls -l /var/lib/snapd/save/snap/test-snapd-sh"

    # instance environment variables are correctly set up
    tests.nested exec "snap run test-snapd-sh.sh -c 'env' test > snap_foo-env.txt"
    tests.nested exec "grep 'SNAP_SAVE_DATA=/var/lib/snapd/save/snap/test-snapd-sh' < snap_foo-env.txt"

    echo "Ensuring we can write a file to /var/lib/snapd/save/snap/test-snapd-sh"
    tests.nested exec "sudo snap run test-snapd-sh.sh -c \"echo 'hello world' > /var/lib/snapd/save/snap/test-snapd-sh/hello.txt\""

    echo "Ensuring we cannot write a file to /var/lib/snapd/save/snap"
    if tests.nested exec "sudo snap run test-snapd-sh.sh -c \"echo 'hello world' > /var/lib/snapd/save/snap/hello.txt\""; then
        tests.nested fail "Writing to /var/lib/snapd/save/snap/hello.txt should have failed"
    fi

    echo "Removing the snap again and making sure that the save folder is removed"
    tests.nested exec "sudo snap remove test-snapd-sh"

    echo "Ensuring the path /var/lib/snapd/save/snap/test-snapd-sh no longer exists"
    tests.nested exec "\[ ! -d \"/var/lib/snapd/save/snap/test-snapd-sh\" \]"
