summary: verify creating recovery system on UC20

systems: [ubuntu-20.04-64]

prepare: |
    # shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    tests.nested exec sudo snap install http

execute: |
    # shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    echo "Create a recovery system with a typical recovery system label"
    boot_id="$( nested_get_boot_id )"
    echo '{"action":"create-recovery-system","params":{"recovery-system-label":"1234"}}' | tests.nested exec sudo http POST snapd:///v2/debug > change.out
    REMOTE_CHG_ID=$(jq -r .change < change.out)
    nested_wait_for_reboot "${boot_id}"
    tests.nested exec sudo snap watch "${REMOTE_CHG_ID}"

    echo "Verify the system is back in run mode"
    tests.nested exec "sudo cat /proc/cmdline" | MATCH snapd_recovery_mode=run

    tests.nested exec "test -f /run/mnt/ubuntu-seed/systems/1234/model"
    tests.nested exec "sudo cat /var/lib/snapd/modeenv" > modeenv
    MATCH 'current_recovery_systems=.*,1234' < modeenv
    MATCH 'good_recovery_systems=.*,1234' < modeenv

    echo "Create a recovery system with an alternative recovery system label"
    boot_id="$( nested_get_boot_id )"
    echo '{"action":"create-recovery-system","params":{"recovery-system-label":"1234-1"}}' | tests.nested exec sudo http POST snapd:///v2/debug > change.out
    REMOTE_CHG_ID=$(jq -r .change < change.out)
    nested_wait_for_reboot "${boot_id}"
    tests.nested exec sudo snap watch "${REMOTE_CHG_ID}"

    echo "Verify the system is back in run mode again"
    tests.nested exec "sudo cat /proc/cmdline" | MATCH snapd_recovery_mode=run

    tests.nested exec "test -f /run/mnt/ubuntu-seed/systems/1234-1/model"
    tests.nested exec "sudo cat /var/lib/snapd/modeenv" > modeenv
    MATCH 'current_recovery_systems=.*,1234-1' < modeenv
    MATCH 'good_recovery_systems=.*,1234-1' < modeenv
