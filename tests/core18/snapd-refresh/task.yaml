summary: Test refreshing snapd and running new units

execute: |
    echo "Testing refresh/revert of snapd"
    current=$(readlink /snap/snapd/current)
    SNAPD_SNAP=$(ls /var/lib/snapd/snaps/snapd_$current.snap)
    for _ in $(seq 10); do

        echo "Installing a new snapd snap"
        snap install --dangerous $SNAPD_SNAP
        echo "Still leaves `snap list` working"
        if snap list | grep "snapd.*$current "; then
            echo "snap install of new snapd did not update to new snapd"
            exit 1
        fi
        running="$(readlink -f /proc/$(pidof snapd)/exe)"
        if echo "$running" | grep "/snap/snapd/$current/usr/lib/"; then
            echo "The current running snapd is not $running"
            exit 1
        fi

        echo "And reverting snapd"
        snap revert snapd
        echo "Also gives us a working snapd"
        snap list | MATCH "snapd.*$current "
        echo "And we see the original snapd running"
        running="$(readlink -f /proc/$(pidof snapd)/exe)"
        echo "$running" | MATCH "/snap/snapd/$current/usr/lib/"
    done
    snap changes | MATCH 'Install "snapd"'
    snap changes | MATCH 'Revert "snapd" snap'
