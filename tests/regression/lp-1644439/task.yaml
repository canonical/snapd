summary: Regression test for https://bugs.launchpad.net/snap-confine/+bug/1644439
details: |
    snap-confine uses privately-shared /run/snapd/ns to store bind-mounted
    mount namespaces of each snap. In the case that snap-confine is invoked
    from the mount namespace it typically constructs that directory is not
    available as it is only visible in the main, outer namespace. In order to
    operate in such an environment snap-confine must first re-associate its own
    process with another namespace in which the /run/snapd/ns directory is
    visible. The most obvious candidate is pid one, which definitely doesn't
    run in a snap-specific namespace, has a predictable PID and is long lived.
prepare: |
    echo "Having installed the test snap in devmode"
    . $TESTSLIB/snaps.sh
    install_local_devmode test-snapd-tools
execute: |
    echo 1 > /sys/module/apparmor/parameters/debug
    echo 0 > /proc/sys/kernel/printk_ratelimit
    echo -n noquiet > /sys/module/apparmor/parameters/audit
    echo "We can run the test snap from itself succesfully!"
    test-snapd-tools.cmd /bin/true
    test-snapd-tools.cmd /bin/sh -c "/snap/bin/test-snapd-tools.cmd /bin/true"
restore: |
    echo 5 > /proc/sys/kernel/printk_ratelimit
debug: |
    # This feature has been noted to cause kernel oops before.
    tail -n 250 /var/log/kern.log
