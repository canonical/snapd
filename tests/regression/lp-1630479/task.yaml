summary: Regression check for https://bugs.launchpad.net/snap-confine/+bug/1630479

details: |
    The PATH environment variable needs to make sense for the layout of the
    core snap. Snap-confine contains code that sets it accordingly but during
    the introduction of the namespace sharing feature that code would run only
    when the namespace was initially constructed. Subsequent calls would not
    see the correct path. 

prepare: |
    echo "Having installed a test snap"
    "$TESTSTOOLS"/snaps-state install-local test-snapd-tools --devmode

execute: |
    echo "We can observe the value of PATH twice"
    #shellcheck disable=SC2016
    one="$(test-snapd-tools.cmd sh -c 'echo $PATH')"
    #shellcheck disable=SC2016
    two="$(test-snapd-tools.cmd sh -c 'echo $PATH')"
    echo "We can see that PATH is stable across calls"
    [ "$one" = "$two" ]
    echo "We can make sure that it has the right value"
    [ "$one" = "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games" ]
    # NOTE: the following parts are notably absent from PATH
    #  - SNAP_MOUNT_DIR="$(os.paths snap-mount-dir)"
    #  - $SNAP_MOUNT_DIR/test-snapd-tools/$revision/bin
    #  - $SNAP_MOUNT_DIR/test-snapd-tools/$revision/usr/bin
    #
    # This is because our test snap is not built with snapcraft and those path
    # elements are only added by the wrappers generated by snapcraft.
