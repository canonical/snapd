summary: Ensure that the location-control interface works.

details: |
    The location-control interface allows a snap to operate as the location service.

    A snap which defines the location-control plug must be shown in the interfaces list.
    The plug must not be autoconnected on install and, as usual, must be able to be
    reconnected.
    The snap is also declaring a plug on this interface must be able to ask for its properties.

prepare: |
    . "$TESTSLIB/dbus.sh"
    . "$TESTSLIB/dirs.sh"
    echo "Given a snap declaring a plug on the location-control interface is installed"
    snap install test-snapd-location-control-provider

    echo "And the provider dbus loop is started"
    start_dbus_unit $SNAP_MOUNT_DIR/bin/test-snapd-location-control-provider.provider

restore: |
    rm -f getprop.error

    . "$TESTSLIB/dbus.sh"
    stop_dbus_unit

execute: |
    CONNECTED_PATTERN="^test-snapd-location-control-provider:location-control-test +test-snapd-location-control-provider:location-control"
    DISCONNECTED_PATTERN="^- +test-snapd-location-control-provider:location-control$"

    echo "The interface is not connected by default"
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "The interface can be connected"
    snap connect test-snapd-location-control-provider:location-control test-snapd-location-control-provider:location-control-test
    snap interfaces | MATCH "$CONNECTED_PATTERN"

    echo "Check the location-control is working from the consumer app in the snap"
    test-snapd-location-control-provider.consumer Get | MATCH "location-get"
    test-snapd-location-control-provider.consumer Set | MATCH "location-set"

    if [ "$(snap debug confinement)" = partial ] ; then
        exit 0
    fi
    
    echo "When the plug is disconnected"
    snap disconnect test-snapd-location-control-provider:location-control test-snapd-location-control-provider:location-control-test
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "And the location provider props cannot be accessed"
    if test-snapd-location-control-provider.consumer Get 2>${PWD}/getprop.error; then
        echo "Expected permission error trying to get props with disconnected plug"
        exit 1
    fi
    MATCH "Permission denied" < getprop.error

    echo "When the plug is re-connected the interfaces show the connection"
    snap connect test-snapd-location-control-provider:location-control test-snapd-location-control-provider:location-control-test
    snap interfaces | MATCH "$CONNECTED_PATTERN"
