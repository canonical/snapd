summary: Ensure network errors are handled gracefully

# autopkgtest run only a subset of tests that deals with the integration
# with the distro
backends: [-autopkgtest]

# no iptables on core18 yet
systems: [-ubuntu-core-18-*]

prepare: |
    iptables-save > rules

restore: |
    echo "Restoring iptables rules"
    iptables-restore < rules

debug: |
    echo "iptables rules"
    iptables -L -n -v

execute: |
    systemctl stop snapd.{socket,service}

    echo "Disabling DNS queries"
    iptables -I OUTPUT -p udp --dport 53 -j REJECT --reject-with icmp-port-unreachable

    systemctl start snapd.{socket,service}

    OUT=$(snap find test 2>&1 || true)
    iptables -D OUTPUT -p udp --dport 53 -j REJECT --reject-with icmp-port-unreachable

    echo "$OUT" | MATCH "error: unable to contact snap store"
