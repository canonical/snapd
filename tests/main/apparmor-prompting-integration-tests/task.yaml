summary: Check that AppArmor Prompting works end-to-end

details: |
    Test that the AppArmor Prompting subsystems work by simulating common usage
    scenarios. Manually carry out operations which generate prompts and, using
    the prompting-client snap in scripted mode, check that those prompts match
    what is expected, and that the client suffessfully allows the operations.

systems:
  - ubuntu-16.04-*
  - ubuntu-18.04-64
  - ubuntu-2*
  - ubuntu-core-*

environment:
    VARIANT/read_single_allow: read_single_allow
    VARIANT/read_single_deny: read_single_deny
    VARIANT/write_single_allow: write_single_allow
    VARIANT/write_single_deny: write_single_deny
    VARIANT/create_multiple_allow: create_multiple_allow
    VARIANT/create_multiple_deny: create_multiple_deny
    #VARIANT/create_multiple_actioned_by_other_pid: create_multiple_actioned_by_other_pid
    #VARIANT/overwrite_file: overwrite_file

prepare: |
    tests.session prepare -u test
    tests.session exec -u test -- sh -c 'mkdir -p "$HOME/integration-tests"' # $HOME must be that of test user
    snap install prompting-client

restore: |
    tests.session exec -u test -- sh -c 'rm -rf "$HOME/integration-tests"' # $HOME must be that of test user
    tests.session restore -u test

debug: |

execute: |
    echo "Enable prompting via snap client where possible"
    # Prompting is unsupported everywhere but the Ubuntu non-core systems with
    # kernels which support apparmor prompting
    if ! os.query is-ubuntu || os.query is-core || ! grep 'prompt' /sys/kernel/security/apparmor/features/policy/permstable32 ; then
        not snap set system experimental.apparmor-prompting=true >& err.out
        if os.query is-core ; then
            MATCH "cannot enable prompting feature as it is not supported on Ubuntu Core systems" < err.out
        else
            MATCH "cannot enable prompting feature as it is not supported by the system" < err.out
        fi

        # even if unsupported setting it to false should succeed
        snap set system experimental.apparmor-prompting=false
        exit 0
    fi

    echo "Enable AppArmor prompting experimental feature"
    snap set system experimental.apparmor-prompting=true

    # Wait for snapd to begin restart
    sleep 1

    echo "Wait until prompting is active"
    retry --wait 1 -n 60 systemctl is-active snapd

    echo "Check that shell script and scripted replies exist for $VARIANT"
    test -f "$VARIANT.sh"
    test -f "$VARIANT.json"

    # Create unique tmpdir and copy the script to it.
    # The tmpdir must be in the test user's home directory.
    TEST_DIR="$(tests.session exec -u test -- sh -c 'mktemp --directory --tmpdir="$HOME/integration-tests"')"
    cp "$VARIANT.json" "${TEST_DIR}/script.json"
    chmod 777 "${TEST_DIR}/script.json" # ensure it's readable by the test user

    # Test scripts can rely on the presence of "${TEST_DIR}/script.json",
    # which is the script of expected prompts and corresponding replies.
    #
    # Test scripts can use $SNAP_DO to execute a command as the prompting
    # client snap, and thus trigger a prompt.

    echo "Run the test script as the test user"
    tests.session exec -u test -- SNAP_DO='snap run --shell prompting-client -c "$*"' sh -ec "${TEST_DIR}/${VARIANT}.sh" "$TEST_DIR"
