summary: Ensure that ECONNRESET is handled

restore: |
    echo "Stop the snap download command"
    kill -9 "$(pgrep -f 'snap download')" || true

    echo "Remove the firewall rule again"
    iptables -D OUTPUT -m owner --uid-owner "$(id -u test)" -j REJECT -p tcp --reject-with tcp-reset || true

    rm -f test-snapd-huge_*
    rm -f snap-download.log

# autopkgtest run only a subset of tests that deals with the integration
# with the distro
backends: [-autopkgtest]

# no iptables on core18 yet
systems: [-ubuntu-core-18-*]

debug: |
    ps -ef
    ls -al
    cat snap-download.log || true
    echo "download log:"
    cat snap-download.log

execute: |
    echo "Downloading a large snap in the background"
    su -c "/usr/bin/env SNAPD_DEBUG=1 SNAPD_DEBUG_HTTP=3 snap download --edge test-snapd-huge 2>snap-download.log" test &

    echo "Wait until the download started and downloaded more than 1 MB"
    echo "starting: $(date)"
    for _ in $(seq 120); do
        partial=$(find . -name 'test-snapd-huge_1.snap.partial' | head -1)
        if [ -n "$partial" ] && [ "$(stat -c%s "$partial")" -gt "$(( 1024 * 1024 ))" ]; then
            break
        fi
        sleep 0.5
    done

    if [ ! -f "$partial" ] || [ "$(stat -c%s "$partial")" -eq 0 ]; then
        echo "Partial file $partial did not start downloading, test broken"
        kill -9 "$(pgrep -f 'snap download')" || true
        ls -al
        cat snap-download.log || true
        kill -9 "$(pgrep -f 'snap download')" || true
        exit 1
    fi

    if [ -f test-snapd-huge_1.snap ]; then
        echo "File fully downloaded before the test could act"
        echo "Test broken"
        ps -ef
        ls -al
        cat snap-download.log || true
        echo "end: $(date)"
        kill -9 "$(pgrep -f 'snap download')" || true
        exit 1
    fi

    echo "Block the download using iptables"
    iptables -I OUTPUT -m owner --uid-owner "$(id -u test)" -j REJECT -p tcp --reject-with tcp-reset

    echo "Check that we retried"
    for _ in $(seq 10); do
        if MATCH 'Retrying.*\.snap, attempt 2' < snap-download.log; then
            break
        fi
        sleep 1
    done

    if [ -n "$(find . -name 'test-snapd-huge_*.snap')" ]; then
        echo "File fully downloaded even after iptables was applied"
        echo "Test broken"
        echo "end: $(date)"
        exit 1
    fi

    MATCH 'Retrying.*\.snap, attempt 2' < snap-download.log

    # Note that the download will not be successful because of the nature of
    # the netfilter testbed. When snap download retries the next attempt will
    # end up with a "connection refused" error, something we do not retry
