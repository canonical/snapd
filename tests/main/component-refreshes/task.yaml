summary: Test refreshing a component from the store

details: |
  Verifies that we can refresh a snap with components from the store.

systems: [ubuntu-16.04-64, ubuntu-18.04-64, ubuntu-2*, ubuntu-core-*, fedora-*]

restore: |
  snap refresh --unhold
  # TODO:COMPS: properly remove the snap and components
  true

execute: |
  snap refresh --hold

  snap install test-snap-component-refreshes+one+two --revision=3 --edge

  # this snap uses a default track "custom", so we should be tracking
  # custom/edge
  snap list test-snap-component-refreshes | awk 'NR != 1 { print $4 }' | MATCH 'custom/edge'

  # verify that the components are installed with the correct revisions (these
  # are component revisions, not snap revisions)
  test-snap-component-refreshes one | MATCH '.*revision 3$'
  test-snap-component-refreshes two | MATCH '.*revision 3$'

  # test refreshing while providing a revision
  snap refresh test-snap-component-refreshes --revision=4
  test-snap-component-refreshes one | MATCH '.*revision 4$'
  test-snap-component-refreshes two | MATCH '.*revision 4$'

  # test just a normal refresh
  snap refresh test-snap-component-refreshes
  test-snap-component-refreshes one | MATCH '.*revision 5$'
  test-snap-component-refreshes two | MATCH '.*revision 5$'

  # go back to a revision we've already installed
  snap refresh test-snap-component-refreshes --revision=4
  test-snap-component-refreshes one | MATCH '.*revision 4$'
  test-snap-component-refreshes two | MATCH '.*revision 4$'
