summary: TBD

systems:
    # Not supposed to work on Ubuntu Core systems as we don't have
    # a user session environment there
    - -ubuntu-core-*

restore: |
    source /tmp/dbus-session-env
    kill -KILL $DBUS_SESSION_BUS_PID || true
    kill -KILL $(cat /tmp/snapd-user-pid) || true
    umount -f /usr/bin/xdg-open


execute: |
    # Install necessary pacakges to get dbus-launch helper
    apt install -y dbus-x11 xdg-utils

    dbus-launch --sh-syntax &> /tmp/dbus-session-env
    . /tmp/dbus-session-env
    /usr/lib/snapd/snapd --user &
    echo $! > /tmp/snapd-user-pid

    # Give snapd --user a moment to start everything
    sleep 1

    # Create a small helper which will tell us if snapd passes
    # the URL correctly to the right handler
    cat << 'EOF' > /tmp/xdg-open
    #!/bin/sh
    echo "$@" > /tmp/xdg-open-output
    EOF
    chmod +x /tmp/xdg-open
    mount --bind /tmp/xdg-open /usr/bin/xdg-open

    ensure_xdg_open_output() {
        . /tmp/dbus-session-env
        rm -f /tmp/xdg-open-output
        /snap/core/current/usr/local/bin/xdg-open $1
        test -e /tmp/xdg-open-output
        test "$(cat /tmp/xdg-open-output)" = $1
    }

    # Ensure http, https and mailto work
    ensure_xdg_open_output "https://snapcraft.io"
    ensure_xdg_open_output "http://snapcraft.io"
    ensure_xdg_open_output "mailto:talk@snapcraft.io"

    # Ensure other schemes are not passed through
    rm /tmp/xdg-open-output
    ! /snap/core/current/usr/local/bin/xdg-open ftp://snapcraft.io
    test ! -e /tmp/xdg-open-output
    ! /snap/core/current/usr/local/bin/xdg-open aabbcc
    test ! -e /tmp/xdg-open-output

    # We need to kill both here as otherwise the task hangs (even
    # if the restore jobs will do this again)
    kill -KILL $(cat /tmp/snapd-user-pid)
    kill -KILL $DBUS_SESSION_BUS_PID
