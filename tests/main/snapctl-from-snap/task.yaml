summary: Check that `snapctl` can be run from the snap

prepare: |
    echo "Build basic test package"
    snapbuild $TESTSLIB/snaps/snapctl-from-snap .
    snap install --dangerous snapctl-from-snap_1.0_all.snap

restore: |
    rm snapctl-from-snap_1.0_all.snap

execute: |
    echo "Verify that context file exists and has proper permissions"
    CONTEXT_FILE=/var/lib/snapd/context/snap.snapctl-from-snap
    if ! test -f $CONTEXT_FILE ; then
        echo "Context file $CONTEXT_FILE is missing"
        exit 1
    fi
    if [ $(stat -c%a $CONTEXT_FILE) != "600" ]; then
        echo "Incorrect permissions of file $CONTEXT_FILE"
        exit 1
    fi
    echo "Verify that context file has expected length"
    wc -c $CONTEXT_FILE | MATCH 44

    echo "Verify that snapctl get can be executed by the app and shows the value set by configure hook"
    /snap/bin/snapctl-from-snap.snapctl-get foo | MATCH bar

    echo "Verify that snapctl set can modify configuration values"
    /snap/bin/snapctl-from-snap.snapctl-set foo=123
    /snap/bin/snapctl-from-snap.snapctl-get foo | MATCH 123

    echo "Verify configuration value with snap get"
    snap get snapctl-from-snap foo | MATCH 123

    echo "Verify that snap context is removed on snap removal"
    snap remove snapctl-from-snap
    if test -f $CONTEXT_FILE ; then
        echo "Context file $CONTEXT_FILE still exists"
        exit 1
    fi
