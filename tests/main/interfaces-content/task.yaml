summary: Ensure that the content sharing interface works.

details: |
    The content-sharing interface interface allows a snap to access contents from
    other snap

    A snap which defines the content sharing plug must be shown in the interfaces list.
    The plug must be autoconnected on install and, as usual, must be able to be
    reconnected.

prepare: |
    echo "Given a snap declaring a content sharing slot is installed"
    snap install --beta test-snapd-content-slot

    echo "And a snap declaring a content sharing plug is installed"
    snap install --beta test-snapd-content-plug

execute: |
    CONNECTED_PATTERN="test-snapd-content-slot:shared-content +test-snapd-content-plug"
    DISCONNECTED_PATTERN="(?s).*?test-snapd-content-slot:shared-content +-.*?- +test-snapd-content-plug"

    echo "Then the snap is listed as connected"
    snap interfaces | grep -Pzq "$CONNECTED_PATTERN"

    echo "And fstab files are created"
    [ $(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l) -gt 0 ]

    echo "And we can use the shared content"
    test-snapd-content-plug.content-plug | grep "Some shared content"

    echo "============================================"

    echo "When the plug is disconnected"
    snap disconnect test-snapd-content-plug:shared-content test-snapd-content-slot:shared-content
    snap interfaces | grep -Pzq "$DISCONNECTED_PATTERN"

    echo "Then the fstab files are removed"
    [ $(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l) -eq 0 ]

    echo "When the plug is reconnected"
    snap connect test-snapd-content-plug:shared-content test-snapd-content-slot:shared-content
    snap interfaces | grep -Pzq "$CONNECTED_PATTERN"

    echo "Then the fstab files are recreated"
    [ $(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l) -gt 0 ]
