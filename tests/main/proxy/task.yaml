summary: Ensure that the core.proxy.* settings are honored

restore: |
    snap set core proxy.https=
    systemctl stop tinyproxy

prepare: |
    systemd-run --unit tinyproxy -- python3 "$(pwd)/tinyproxy.py"
    # shellcheck source=tests/lib/systemd.sh
    . "$TESTSLIB/systemd.sh"
    wait_for_service tinyproxy

execute: |
    echo "Setup proxy config"
    snap set core proxy.https=http://localhost:3128

    echo "Check that the commands go through the proxy"
    snap find test-snapd-tools | MATCH test-snapd-tools

    # check unit outout
    # shellcheck source=tests/lib/journalctl.sh
    . "$TESTSLIB/journalctl.sh"
    check_journalctl_log 'CONNECT api.snapcraft.io' -u tinyproxy
