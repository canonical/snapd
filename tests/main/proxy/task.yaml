summary: Ensure that the core.proxy.* settings are honored

restore: |
    snap set core proxy.https=
    systemctl stop tinyproxy

prepare: |
    systemd-run --unit tinyproxy -- python3 $(pwd)/tinyproxy.py

execute: |
    echo "Setup proxy config"
    snap set core proxy.https=http://localhost:3128

    echo "Check that the commands go through the proxy"
    snap find test-snapd-tools | MATCH test-snapd-tools

    # check unit outout
    for _ in $(seq 10); do
        if journalctl -u tinyproxy | grep -E "CONNECT api.snapcraft.io"; then
            break
        fi
        sleep 1
    done
    journalctl -u tinyproxy | MATCH "CONNECT api.snapcraft.io"
