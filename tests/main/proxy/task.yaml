summary: Ensure that the core.proxy.* settings are honored

# ubuntu-14.04 does not have systemd-run
systems: [-ubuntu-14.04-*]

restore: |
    snap set core proxy.https=
    systemctl stop tinyproxy || true

execute: |
    if ! command -v python3; then
       echo "SKIP: need python3"
       exit 0
    fi
    if [ -n "${http_proxy:-}" ] || [ -n "${https_proxy:-}" ] ||
       [ -n "${HTTPS_PROXY:-}" ] || [ -n "${HTTPS_PROXY:-}" ]; then
       echo "SKIP: cannot run when there is another http proxy"
       exit 0
    fi

    systemd-run --service-type=notify --unit tinyproxy -- python3 "$TESTSLIB/tinyproxy/tinyproxy.py"
    # shellcheck source=tests/lib/systemd.sh
    . "$TESTSLIB/systemd.sh"
    wait_for_service tinyproxy

    echo "Setup proxy config"
    snap set core proxy.https=http://localhost:3128

    echo "Check that the commands go through the proxy"
    snap find test-snapd-tools | MATCH test-snapd-tools

    # check unit output
    "$TESTSTOOLS"/journal-state match-log 'CONNECT api.snapcraft.io' -u tinyproxy
