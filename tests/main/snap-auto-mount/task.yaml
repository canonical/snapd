summary: Check that `snap auto-import` works as expected

systems: [ubuntu-core-16-64,ubuntu-core-16-arm-32,ubuntu-core-16-arm-64]

prepare: |
    echo "Install dmsetup"
    snap install --devmode --edge dmsetup

    echo "Ensure the developer1.account is not already added"
    output=$(snap known account | grep "account-id: developer1" | wc -l)
    if [ "$output" != "0" ]; then
        echo "developer1.account assertion already part of the system"
        exit 1
    fi
    echo "Create a ramdisk with the developer1.account assertion"
    mkfs.ext4 /dev/ram0
    mount /dev/ram0 /mnt
    cp $TESTSLIB/assertions/developer1.account /mnt/auto-import.assert
    umount /mnt

    echo "Create new block device to trigger auto-import mount"
    dmsetup -v --noudevsync --noudevrules create dm-ram0 --table '0 65536 linear /dev/ram0 0'

restore: |
    dmsetup -v --noudevsync --noudevrules  remove dm-ram0 

execute: |
    echo "The auto-mount magic has given us the assertion"
    snap known account | grep "account-id: developer1"
