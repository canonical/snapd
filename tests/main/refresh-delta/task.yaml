summary: Check that the refresh command uses deltas

details: Check that the refresh command uses deltas when downloading a snap.

environment:
    SNAP_NAME_XDELTA3: test-snapd-delta-refresh
    SNAP_NAME_SNAP_DELTA: test-delta-refresh
    # on core systems, the test was seen to misbehave when memory limit is set
    SNAPD_NO_MEMORY_LIMIT: 1

prepare: |
    echo "Install snaps"
    snap install --edge "$SNAP_NAME_XDELTA3"
    snap install --edge "$SNAP_NAME_SNAP_DELTA"

restore: |
     sudo snap unset system experimental.snap-delta-format

execute: |
    echo "Refresh, xdelta3"
    snap refresh --beta "$SNAP_NAME_XDELTA3"
    "$TESTSTOOLS"/journal-state match-log "Successfully applied delta"

    "$TESTSTOOLS"/journal-state start-new-log
    # snap xdelta3 is experimental at the moment
     sudo snap set system experimental.snap-delta-format=true

    echo "Refresh, snap-delta"
    snap refresh --beta "$SNAP_NAME_SNAP_DELTA"
    "$TESTSTOOLS"/journal-state match-log "Available deltas returned by store: .*snap-1-1-xdelta3"
    "$TESTSTOOLS"/journal-state match-log "Successfully applied delta .*snap.snap-1-1-xdelta3"
