summary: Test that we use the right buildmode per arch

systems: [ubuntu-1*, ubuntu-2*]

execute: |
    # `objdump -f` will report "DYNAMIC" for binaries build with
    # -buildmode=pie
    needle="DYNAMIC"
    
    # armhf/i386 build without -buildmode=pie as it breaks too many
    # things if we do.
    if [ "$(uname -m)" = armv7l ] || [ "$(uname -m)" = i686 ]; then
        # and "EXEC_P" when the buildmode is "normal"
        needle="EXEC_P"
    fi

    # check /usr/bin/snap
    objdump -f /usr/bin/snap | MATCH "$needle"
    # and the helpers in /usr/lib/snapd
    for p in snapd snap-repair; do
        objdump -f /usr/lib/snapd/"$p" | MATCH "$needle"
    done
