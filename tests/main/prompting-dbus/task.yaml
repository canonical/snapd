summary: check that cerberus can process prompting

# TODO: enable on more systems
systems: [ubuntu-23.04-64]

prepare: |
    # cannot use "tests.cleanup defer" here until no more reboot is needed
    apt update
    # no need to cleanup, setup/teardown will remove extra pkgs
    # automatically
    apt install -y software-properties-common
    apt-add-repository -y ppa:apparmor-dev/prompt-dev
    apt install -y --allow-downgrades apparmor= 3.0.8-1ubuntu2+prompt48
    # TODO: this is only needed for as long as prompting is not in
    # the default lunar kernel.
    if [ ! -e /sys/kernel/security/apparmor/.notify ]; then
        uname -r > kernel-uname-r.txt
        # no need to cleanup, setup/teardown will remove extra pkgs
        # automatically
        apt install -y --allow-downgrades  linux-image-6.2.0-20-generic
        # ensure there is no newer kernel
        apt remove -y linux-image-6.2.0-18-generic
        # TODO2: if the PPA kernel version is lower than the distro kernel
        # ensure that the newer distro kernel gets removed here

        # Reboot to use the remaining kernel.
        if [ "$SPREAD_REBOOT" -eq 0 ]; then
            REBOOT
        fi
    fi

    # Run the flip-flop fake agent
    systemd-run --unit fake-agent.service \
        --property=StandardOutput=file:"$(pwd)/fake-agent.log" \
        --property=StandardError=inherit \
        "$(pwd)/fake-agent.py"

restore: |
    snap unset system experimental.apparmor-prompting
    systemctl stop fake-agent.service || true
    # TODO: remove once aa-prompt is the default
    if [ -e /sys/kernel/security/apparmor/.notify ]; then
        apt install -y --allow-downgrades "linux-image-$(cat kernel-uname-r.txt)"
        if [ "$SPREAD_REBOOT" -eq 0 ]; then
            REBOOT
        fi
    fi
    apt-add-repository -r ppa:apparmor-dev/prompt-dev
    apt install -y apparmor

debug: |
    cat fake-agent.log
    gdbus introspect --system --dest io.snapcraft.AppArmorPrompt --object-path /io/snapcraft/AppArmorPrompt || true

execute: |
    # enable prompting (TODO: this should trigger a profile rebuild)
    snap set system experimental.apparmor-prompting=true

    # TODO: enabling prompting does not rebuild the home profile right
    # now so this install needs to happen after the prompting option
    # is set or otherwise old apparmor profiles are used
    "$TESTSTOOLS"/snaps-state install-local home-consumer

    # check that reading a file in home triggers a prompt
    echo "ok" > "$HOME/test-file-1"
    home-consumer.reader "$HOME/test-file-1" > output.txt
    test "$(grep -E -c 'Prompt()' fake-agent.log)" -eq 1
    MATCH "ok" < output.txt

    # The fake-prompt just flip-flops with yes/no so the second time should
    # trigger a denial
    echo "no" > "$HOME/test-file-2"
    if home-consumer.reader "$HOME/test-file-2"; then
        echo "expected apparmor denial"
        exit 1
    fi
    test "$(grep -E -c 'Prompt()' fake-agent.log)" -eq 2
