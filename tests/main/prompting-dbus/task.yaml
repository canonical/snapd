summary: check that cerberus can process prompting

# TODO: enable on more systems
systems: [ubuntu-23.04-64]

prepare: |
    # ensure the listener is in debug mode
    mkdir -p /etc/systemd/system/snapd.aa-prompt-listener.service.d/
    printf "[Service]\nEnvironment=SNAPD_DEBUG=1\n" > /etc/systemd/system/snapd.aa-prompt-listener.service.d/debug.conf
    systemctl daemon-reload
    systemctl restart snapd.aa-prompt-listener.service

    # cannot use "tests.cleanup defer" here until no more reboot is needed
    apt update
    # no need to cleanup, setup/teardown will remove extra pkgs
    # automatically
    apt install -y software-properties-common
    apt-add-repository -y ppa:apparmor-dev/prompt-dev
    # TODO: this is only needed for as long as prompting is not in
    # the default lunar kernel.
    if [ "$SPREAD_REBOOT" -eq 0 ]; then
        uname -r > kernel-uname-r.txt
        # no need to cleanup, setup/teardown will remove extra pkgs
        # automatically
        apt install -y --allow-downgrades  linux-image-6.2.0-20-generic
        # ensure there is no newer kernel
        # XXX: can be removed once the newer kernel acually works
        #apt remove -y linux-image-6.2.0-21-generic
        # TODO2: if the PPA kernel version is lower than the distro kernel
        # ensure that the newer distro kernel gets removed here
        REBOOT
    fi
    # Run the flip-flop fake agent
    systemd-run --unit fake-agent.service \
        --property=StandardOutput=file:"$(pwd)/fake-agent.log" \
        --property=StandardError=inherit \
        "$(pwd)/fake-agent.py"
    # use the home-consumer for testing prompting
    "$TESTSTOOLS"/snaps-state install-local home-consumer
    # TODO: build/install the snapcraft snap here to get the vendored userland
    #
    # Build the custom userspace version that supports prompting from
    # JJs branch (TOOD: keep in sync with what the snapd snap uses)
    pushd /tmp
    apt build-dep -y apparmor
    git clone https://gitlab.com/jjohansen/apparmor.git
    cd apparmor
    git checkout prompt
    # build libapparmor first
    cd libraries/libapparmor
    ./autogen.sh
    ./configure --prefix=/usr --disable-man-pages --disable-perl --disable-python --disable-ruby
    make -j$(nproc)
    make -C src install
    # then build parser
    cd ../../parser
    make -j$(nproc)
    make install DESTDIR=/usr
    popd
    # XXX: uncomment to test apprmor from PPA
    #apt install -y --allow-downgrades apparmor=3.0.8-1ubuntu2+prompt48

restore: |
    snap unset system experimental.apparmor-prompting
    systemctl stop fake-agent.service || true
    # TODO: remove once aa-prompt is the default
    if [ "$SPREAD_REBOOT" -eq 0 ]; then
        apt install -y --allow-downgrades "linux-image-$(cat kernel-uname-r.txt)"
        REBOOT
    fi
    apt-add-repository -r ppa:apparmor-dev/prompt-dev
    # TODO: remove this
    apt install -y apparmor

debug: |
    journalctl -u fake-agent.service
    journalctl -u snapd.aa-prompt-listener
    cat fake-agent.log
    gdbus introspect --system --dest io.snapcraft.AppArmorPrompt --object-path /io/snapcraft/AppArmorPrompt || true

execute: |
    # this will rebuild the profiles
    snap set system experimental.apparmor-prompting=true
    MATCH '^prompt ' < /var/lib/snapd/apparmor/profiles/snap.home-consumer.reader

    # check that reading a file in home triggers a prompt
    echo "ok" > "$HOME/test-file-1"
    home-consumer.reader "$HOME/test-file-1" > output.txt
    test "$(grep -E -c 'Prompt()' fake-agent.log)" -eq 1
    MATCH "ok" < output.txt

    # The fake-prompt just flip-flops with yes/no so the second time should
    # trigger a denial
    echo "no" > "$HOME/test-file-2"
    if home-consumer.reader "$HOME/test-file-2"; then
        echo "expected apparmor denial"
        exit 1
    fi
    test "$(grep -E -c 'Prompt()' fake-agent.log)" -eq 2

    # read something outside of /home should trigger a denial and no prompt
    if home-consumer.reader "/proc/modules/"; then
        echo "expected apparmor denial outside /home"
        exit 1
    fi
    test "$(grep -E -c 'Prompt()' fake-agent.log)" -eq 2
