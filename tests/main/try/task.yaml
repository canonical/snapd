summary: Check that try command works

# s390x does not have /dev/kmsg
systems: [-ubuntu-core-*, -fedora-*, -opensuse-*, -arch-*, -ubuntu-*-s390x]

environment:
    PORT: 8081
    SERVICE_FILE: "./service.sh"
    READABLE_FILE: "/var/snap/test-snapd-tools/x1/file.txt"
    SERVICE_NAME: "test-service"

prepare: |
    . $TESTSLIB/systemd.sh
    echo "Given a service listening on a port"
    printf "#!/bin/sh -e\nwhile true; do printf \"HTTP/1.1 200 OK\n\nok\n\" |  nc -l -p $PORT -w 1; done" > $SERVICE_FILE
    chmod a+x $SERVICE_FILE
    systemd_create_and_start_unit $SERVICE_NAME "$(readlink -f $SERVICE_FILE)"

    while ! netstat -lnt | grep -Pq "tcp.*?:$PORT +.*?LISTEN\n*"; do sleep 0.5; done

restore: |
    . $TESTSLIB/systemd.sh
    systemd_stop_and_destroy_unit $SERVICE_NAME
    rm -f $SERVICE_FILE $READABLE_FILE

execute: |
    echo "Given a buildable snap in a known directory"
    echo "When try is executed on that directory"
    snap try $TESTSLIB/snaps/test-snapd-tools

    echo "Then the snap is listed as installed with try in the notes"
    snap list | MATCH '^test-snapd-tools .* try'

    echo "And commands from the snap-try binary can be run"
    test-snapd-tools.success

    echo "And commands from the snap-try binary can read in a readable dir"
    echo -n "Hello World" > $READABLE_FILE
    test-snapd-tools.cat $READABLE_FILE | MATCH "Hello World"

    echo "====================================="

    echo "Given a buildable snap which access confinement-protected resources in a known directory"
    echo "When try is executed on that directory"
    snap try $TESTSLIB/snaps/test-snapd-tools

    if [ "$(snap debug confinement)" = strict ] ; then
        echo "Then the snap command is not able to access the protected resource"
        if test-snapd-tools.head -1 /dev/kmsg; then
            echo "Expected confinement denial in try mode didn't work"
            exit 1
        fi
    fi

    echo "====================================="

    echo "Given a buildable snap which access confinement-protected resources in a known directory"
    echo "When try is executed on that directory with devmode enabled"
    snap try $TESTSLIB/snaps/test-snapd-tools --devmode

    echo "Then the snap command is able to access the protected resource"
    test-snapd-tools.head -1 /dev/kmsg

    echo "====================================="

    echo "Given a buildable snap which access confinement-enabled network resources in a known directory"
    echo "When try is executed on that directory"
    snap try $TESTSLIB/snaps/network-consumer

    echo "Then the snap is able to access the network resource"
    network-consumer http://127.0.0.1:$PORT | MATCH "ok"

    echo "====================================="
    n=test-snapd-classic-confinement
    s=$TESTSLIB/snaps/$n
    echo "Given a buildable snap with classic confinement:"
    echo " - you can't try it without --classic:"
    snap try $s && exit 1 || true
    snap try --jailmode $s && exit 1 || true
    snap try --devmode $s && exit 1 || true

    touch /tmp/lala

    echo " - you can try it with --classic:"
    snap try --classic $s
    snap list $n | MATCH $n.*classic
    $n | MATCH lala
    snap remove $n

    # SOON:
    # echo " - you can also try it with --classic --jailmode:"
    # snap try --classic --devmode $s
    # snap list $n | MATCH "$n.*(classic,jailmode|jailmode,classic)"
    # $n | MATCH lala
