summary: Check that AppArmor Prompting support is as expected

details: |
    Test that AppArmor Prompting is supported on the systems for which support
    is expected (non-core Ubuntu systems from mantic on), and unsupported on
    all other systems.

systems:
    - -ubuntu-14.04*

prepare: |
    # Before enabling prompting, we must have a snap installed which provides
    # a prompting `handler-service` attribute with a connection via the
    # `snap-interfaces-requests-control` interface.

    # Prerequisite for having a prompts handler service
    snap set system experimental.user-daemons=true

    # Install a snap which identifies itself to snapd as a prompting handler-service
    "$TESTSTOOLS"/snaps-state install-local test-snapd-prompt-handler
    snap connect test-snapd-prompt-handler:snap-interfaces-requests-control

restore: |
    snap set system experimental.apparmor-prompting=false

debug: |
    uname -a
    snap debug api /v2/system-info

execute: |
    echo "Precondition check that snapd is active"
    systemctl is-active snapd.service snapd.socket

    # Apparmor prompting feature is not supported in Ubuntu core
    if os.query is-core; then
        not snap set system experimental.apparmor-prompting=true >& err.out
        MATCH "cannot enable prompting feature as it is not supported on Ubuntu Core systems" < err.out

    # Prompting is not yet support outside of Ubuntu
    elif not os.query is-ubuntu ; then
        echo "Expect failure to enable prompting on non-Ubuntu systems"
        not snap set system experimental.apparmor-prompting=true >& err.out
        MATCH "cannot enable prompting feature as it is not supported by the system" < err.out

    # For Ubuntu prior to 22.04, the kernel does not support prompting
    elif os.query is-ubuntu-lt 22.04 ; then
        echo "Expect failure to enable prompting on Ubuntu prior to 22.04"
        not snap set system experimental.apparmor-prompting=true >& err.out
        MATCH "cannot enable prompting feature as it is not supported by the system" < err.out

    # For Ubuntu 22.04, the system AppArmor parser does not support prompting,
    # so expect failure when reexec is not in use.
    elif os.query is-ubuntu 22.04 && not tests.info is-reexec-in-use ; then
        echo "Expect failure to enable prompting on Ubuntu 22.04 without reexec"
        not snap set system experimental.apparmor-prompting=true >& err.out
        MATCH "cannot enable prompting feature as it is not supported by the system" < err.out

    # For Ubuntu 22.04, prompting is only supported if the kernel is at least 6.7"
    elif os.query is-ubuntu 22.04 && os.query is-kernel-lt 6.7 ; then
        echo "Expect failure to enable prompting on Ubuntu 22.04 with kernel < 6.7"
        not snap set system experimental.apparmor-prompting=true >& err.out
        MATCH "cannot enable prompting feature as it is not supported by the system" < err.out

    # The rest of the ubuntu systems shouldn't show any errors, since they
    # should all have kernel > 6.7 and parser support.
    else
        echo "Expect prompting support"
        snap set system experimental.apparmor-prompting=true >& err.out
        test -z "$(cat err.out)"
    fi
