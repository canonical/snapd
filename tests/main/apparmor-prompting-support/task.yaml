summary: Check that AppArmor Prompting works end-to-end

details: |
    Test that the AppArmor Prompting subsystems work by simulating common usage
    scenarios. Manually carry out operations which generate prompts and, using
    the prompting-client snap in scripted mode, check that those prompts match
    what is expected, and that the client carries out the operations as intended.

    Details about the operation of the prompting client in scripted mode:
    https://github.com/canonical/prompting-client/blob/main/docs/running-the-scripted-client.md


systems:
  - ubuntu-16*
  - ubuntu-18*
  - ubuntu-2*
  - ubuntu-core-*-64-*

prepare: |
    snap install prompting-client

restore: |
    snap set system experimental.apparmor-prompting=false

execute: |
    echo "Precondition check that snapd is active"
    systemctl is-active snapd.service snapd.socket

    echo "Enable prompting via snap client where possible"
    not snap set system experimental.apparmor-prompting=true >& err.out

    # Apparmor prompting feature is not supported in Ubuntu core
    if os.query is-core; then        
        MATCH "cannot enable prompting feature as it is not supported on Ubuntu Core systems" < err.out

    # Ubuntu 16.04, 18.04 and 20.04 have kernels which don't support prompting
    # For Ubuntu 22.04 kernel is new enough to support prompting, but the apparmor parser is not, unless we're
    # using snapd-vendored apparmor, which we usually are but when reexec is disabled. 
    elif os.query is-ubuntu-le 20.04 || is-ubuntu 22.04 && not tests.info is-reexec-in-use; then
        MATCH "cannot enable prompting feature as it is not supported by the system" < err.out

    # The rest of the systems shouldn't show any errors
    else
        test -z "$(cat err.out)"
    fi
