summary: Ensures that the mount-observe interface works

details: |
    A snap declaring the mount-observe plug is defined, its command
    just read the /proc/<pid>/mounts file.

    The test itself checks for the lack of autoconnect and then tries
    to execute the snap command with the plug connected (it must succeed)
    and disconnected (it must fail).

    The test also checks that a new mount created after the snap is installed
    is also shown when the plug is connected.

prepare: |
    echo "Given a snap declaring a plug on the mount-observe interface is installed"
    snapbuild $TESTSLIB/snaps/mount-observe-consumer .
    snap install mount-observe-consumer_1.0_all.snap

restore: |
    rm -f mount-observe-consumer_1.0_all.snap

execute: |
    CONNECTED_PATTERN=":mount-observe +mount-observe-consumer"
    DISCONNECTED_PATTERN="(?s).*?\n- +mount-observe-consumer:mount-observe"

    echo "Then the plug is shown as disconnected"

    echo "========================================="

    echo "When the plug is connected"

    echo "Then the mount info is reachable"

    echo "========================================="

    echo "When the plug is disconnected"

    echo "Then the mount info is not reachable"

    echo "========================================="

    echo "When the plug is connected"

    echo "And a new mount is created"

    echo "Then the new mount info is reachable"
