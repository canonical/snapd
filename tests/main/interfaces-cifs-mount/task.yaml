summary: Ensure that the cifs-mount interface works.

details: |
    The cifs-mount interface allows mounting and unmounting CIFS filesystems.

prepare: |
    snap install test-snapd-cifs-mount

    # Create linux and samba users 
    useradd -s /bin/true test-cifs
    echo "test-cifs:test123#" | chpasswd
    mkdir /home/test-cifs

    echo test > test-pass
    echo test >> test-pass
    smbpasswd -a test-cifs -s < test-pass

    # Create mount point
    mkdir -p local_share
    test-snapd-cifs-mount.sh -c "mkdir \$SNAP_DATA/local_mount"
    chmod 755 local_share
    touch local_share/test

    # Configure samba
    cp /etc/samba/smb.conf /etc/samba/smb.conf.back
    { echo "[data]"; echo "path=$(pwd)/local_share"; echo "writable=yes"; echo "browsable=yes"; } >> /etc/samba/smb.conf

    systemctl restart smbd.service

restore: |
    rm -f call.error test-pass
    rm -rf local_share /var/snap/test-snapd-cifs-mount/current/local_mount

    # Restore samba configuration
    smbpasswd -x test-cifs || true
    userdel test-cifs
    cp /etc/samba/smb.conf.back /etc/samba/smb.conf || true
    systemctl restart smbd.service

execute: |
    echo "The interface is not connected by default"
    snap interfaces -i cifs-mount | MATCH -- '^- +test-snapd-cifs-mount:cifs-mount'

    echo "When the interface is connected"
    snap connect test-snapd-cifs-mount:cifs-mount

    echo "Then the snap is able to mount and umount a cifs fs"
    test-snapd-cifs-mount.sh -c "mount -t cifs //127.0.0.1/data \$SNAP_DATA/local_mount -o user=test-cifs,passowrd=test"
    test-snapd-cifs-mount.sh -c "test -f \$SNAP_DATA/local_mount/test"
    
    test-snapd-cifs-mount.sh -c "umount \$SNAP_DATA/local_mount"
    test-snapd-cifs-mount.sh -c "! test -f \$SNAP_DATA/local_mount/test"

    if [ "$(snap debug confinement)" = partial ] ; then
        exit 0
    fi

    echo "When the plug is disconnected"
    snap disconnect test-snapd-cifs-mount:cifs-mount

    echo "Then the snap is not able to mount a cifs filesystem"
    if test-snapd-cifs-mount.sh -c "mount -t cifs //127.0.0.1/data \$SNAP_DATA/local_mount -o user=test-cifs,passowrd=test" 2>call.error; then
        echo "Expected permission error mounting cifs"
        exit 1
    fi
    MATCH "Permission denied" < call.error
