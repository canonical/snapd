summary: Ensure that the physical memory observe interface works.

details: |
    The physical-memory-observe interface allows to read the physical memory.

    The test-snapd-physical-memory-observe snap checks that /dev/mem can be read
    and the interface can be connected and disconnected. 

prepare: |
    echo "Given the physical-memory-observe snap is installed"
    snap try $TESTSLIB/snaps/test-snapd-physical-memory-observe

restore: |
    rm -f call.error

execute: |
    CONNECTED_PATTERN=":physical-memory-observe +test-snapd-physical-memory-observe"
    DISCONNECTED_PATTERN="\- +test-snapd-physical-memory-observe:physical-memory-observe"

    echo "The interface is not connected by default"
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "When the interface is connected"
    snap connect test-snapd-physical-memory-observe:physical-memory-observe

    echo "Then the snap is able access to the physical memory"
    test-snapd-physical-memory-observe.head

    if [ "$(snap debug confinement)" = partial ] ; then
        exit 0
    fi

    echo "When the plug is disconnected"
    snap disconnect test-snapd-physical-memory-observe:physical-memory-observe
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "Then the snap is not able to access the physical memory"
    if test-snapd-physical-memory-observe.head 2>${PWD}/call.error; then
        echo "Expected permission error accessing to physical memory with disconnected plug"
        exit 1
    fi
    MATCH "Permission denied" < call.error
