summary: Run snap sign to sign a model assertion

# ppc64el disabled because of https://github.com/snapcore/snapd/issues/2502
systems: [-ubuntu-core-16-*, -ubuntu-*-ppc64el]

prepare: |
    . "$TESTSLIB/mkpinentry.sh"

execute: |
    # expect does not work on some hardware in autopkgtest like ppc64el
    echo "Check if expect is working at all"
    if ! expect -f works.exp; then
        echo "SKIP: expect broken in this environment"
    fi

    echo "Creating a new key without a password"
    expect -f create-key.exp

    echo "Ensure we have the new key"
    snap keys|grep default
    key=$(snap keys|grep default|tr -s ' ' |cut -f2 -d' ')

    echo "Create an example model assertion"
    cat <<EOF >pi3-model.json
    {
      "type": "model",
      "authority-id": "test",
      "brand-id": "test",
      "series": "16",
      "model": "pi3",
      "architecture": "armhf",
      "gadget": "pi3",
      "kernel": "pi2-kernel",
      "timestamp": "$(date --utc '+%FT%T%:z')"
    }
    EOF
    echo "Sign the model assertion with our key"
    expect -d -f sign-model.exp

    echo "Verify that the resulting model assertion is signed"
    grep "sign-key-sha3-384: $key" pi3.model

restore: |
    rm -f pi3.model
    rm -f pi3-model.json
