summary: Check that auto-refresh is retried after a permanent network error

# FIXME: core18 right now does not have a canonical model. This means
# that it will not get a serial. We code in devicestate.go that will only
# try to auto-refresh after the systems has tried at least 3 times to get
# a serial. But this means this test will timeout because the first retry
# for the serial happens after 5min, then 10min, then 20min.
systems: [-ubuntu-core-18-*]

prepare: |
    snap install --devmode jq
    cp /lib/systemd/system/snapd.service /lib/systemd/system/snapd.service.bak

restore: |
    mv -f /lib/systemd/system/snapd.service.bak /lib/systemd/system/snapd.service

debug: |
    ip netns list
    ip netns pids testns || true

execute: |
    # shellcheck source=tests/lib/journalctl.sh
    . "$TESTSLIB/journalctl.sh"

    echo "Install a snap from stable"
    snap install test-snapd-tools
  
    snap set system refresh.schedule="0:00-23:59"
    systemctl stop snapd.{service,socket}

    echo "Modify the snap to track the edge channel"
    jq ".data.snaps[\"test-snapd-tools\"].channel = \"edge\"" /var/lib/snapd/state.json > /var/lib/snapd/state.json.new
    mv /var/lib/snapd/state.json.new /var/lib/snapd/state.json

    echo "And force auto-refresh to happen"
    jq ".data[\"last-refresh\"] = \"2007-08-22T09:30:44.449455783+01:00\"" /var/lib/snapd/state.json > /var/lib/snapd/state.json.new
    mv /var/lib/snapd/state.json.new /var/lib/snapd/state.json

    # restart snapd in a network namespace
    ip netns add testns
    sed -i 's+ExecStart=\(/usr/lib/snapd/snapd\)+ExecStart=/usr/bin/nsenter --net=/var/run/netns/testns \1+' /lib/systemd/system/snapd.service
    systemctl daemon-reload
    systemctl start snapd.{socket,service}

    echo "wait for auto-refresh to happen and fail"
    for _ in $(seq 120); do
        if get_journalctl_log | MATCH "state ensure error"; then
            break
        fi
        echo "Ensure refresh"
        snap debug ensure-state-soon
        sleep 5
    done

    journalctl | MATCH "state ensure error: unretried network error"

    # restart snapd with network access back
    systemctl stop snapd.{service,socket}
    cp /lib/systemd/system/snapd.service.bak /lib/systemd/system/snapd.service
    systemctl daemon-reload
    systemctl start snapd.{socket,service}

    echo "wait for auto-refresh to happen"
    for _ in $(seq 120); do
        if snap changes|grep -q "Done.*Auto-refresh snap \"test-snapd-tools\""; then
            break
        fi
        echo "Ensure refresh"
        snap debug ensure-state-soon
        sleep 5
    done

    echo "Ensure our snap got updated"
    snap list|MATCH "test-snapd-tools +[0-9]+\\.[0-9]+\\+fake1"

