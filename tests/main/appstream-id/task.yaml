summary: Verify AppStream ID integration
# ubuntu-*-32: the snap used in the test was published only for amd64
# fedora-*: uses GNU netcat by default
# ubuntu-core-16-arm-*: the snap used in the test was published only for amd64
# core18 has no "nc"
systems: [-ubuntu-*-32, -fedora-*, -ubuntu-core-16-arm-*, -ubuntu-core-18-* ]

prepare: |
    snap install jq

restore: |
    snap remove jq

execute: |
    echo "Verify that search results contain common-ids"
    printf 'GET /v2/find?name=test-snapd-appstreamid HTTP/1.0\r\n\r\n' | \
        nc -U -q 1 /run/snapd.socket| grep '{'| \
        jq -r ' .result[0]["common-ids"] | sort | join (",")' | \
        MATCH 'io.snapcraft.test-snapd-appstreamid.bar,io.snapcraft.test-snapd-appstreamid.foo'

    snap install --edge test-snapd-appstreamid

    echo "Verify that installed snap info contains common-ids"
    printf 'GET /v2/snaps/test-snapd-appstreamid HTTP/1.0\r\n\r\n' | \
        nc -U -q 1 /run/snapd.socket| grep '{'| \
        jq -r ' .result["common-ids"] | sort | join(",")' | \
        MATCH 'io.snapcraft.test-snapd-appstreamid.bar,io.snapcraft.test-snapd-appstreamid.foo'

    echo "Verify that apps have their common-id set"
    printf 'GET /v2/apps?names=test-snapd-appstreamid HTTP/1.0\r\n\r\n' | \
        nc -U -q 1 /run/snapd.socket| grep '{'| \
        jq -r ' .result | sort_by(.name) | [.[]."common-id"] | join(",")' | \
        MATCH 'io.snapcraft.test-snapd-appstreamid.bar,,io.snapcraft.test-snapd-appstreamid.foo'
