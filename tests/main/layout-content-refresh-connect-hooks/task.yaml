summary: Verify consumer provided content to be visible when content plug connection hook executes

details: |
    Verify that the content provided by the content slot snap is visible to a
    plug connect hook during its execution.

environment:
    STORE_DIR: $(pwd)/fake-store-blobdir
    STORE_ADDR: localhost:11028

skip:
    - reason: "Test keys need to be trusted"
      if: |
          [ "$TRUST_TEST_KEYS" = "false" ]

prepare: |
    snap install core24

    "$TESTSTOOLS"/store-state setup-fake-store "$STORE_DIR"
    tests.cleanup defer "$TESTSTOOLS"/store-state teardown-fake-store "$STORE_DIR"

    snap ack "$TESTSLIB/assertions/testrootorg-store.account-key"
    snap ack "$TESTSLIB/assertions/developer1.account"
    snap ack "$TESTSLIB/assertions/developer1.account-key"

    cp "$TESTSLIB"/assertions/testrootorg-store.account-key "$STORE_DIR/asserts"
    cp "$TESTSLIB"/assertions/developer1.account "$STORE_DIR/asserts"
    cp "$TESTSLIB"/assertions/developer1.account-key "$STORE_DIR/asserts"

    # provider snaps
    snap pack test-snapd-content-provider-v1
    snap pack test-snapd-content-provider-v2

    "$TESTSTOOLS"/store-state make-snap-installable --revision 1 "$STORE_DIR" \
        test-snapd-content-provider_1*.snap provider-id

    # consumer snap
    snap pack test-snapd-content-consumer
    "$TESTSTOOLS"/store-state make-snap-installable --revision 1 "$STORE_DIR" \
        test-snapd-content-consumer_1.*.snap consumer-id

debug: |
    cat /var/snap/test-snapd-content-consumer/common/hook.log || true

execute: |
    # install the first version
    snap install test-snapd-content-consumer

    # the provider was pulled in and the plug is connected
    snap connections test-snapd-content-consumer | MATCH "test-snapd-content-provider:special-content-basic"
    # content-extra plug is not connected
    snap connections test-snapd-content-consumer | MATCH "test-snapd-content-consumer:special-content-extra +-"

    test-snapd-content-consumer.app |& tee output.log
    MATCH 'hello from app' < output.log
    # check logs from connect hook
    MATCH "connect content basic" < /var/snap/test-snapd-content-consumer/common/hook.log
    NOMATCH "connect content extra" < /var/snap/test-snapd-content-consumer/common/hook.log

    # make v2 now available
    "$TESTSTOOLS"/store-state make-snap-installable --revision 2 "$STORE_DIR" \
        test-snapd-content-provider_2*.snap provider-id

    # refresh, a new slot should be auto connected, which is observed by the
    # connect plug hook on the content consumer
    snap refresh test-snapd-content-provider

    # new provider was pulled in and is connected now
    snap connections test-snapd-content-consumer | MATCH "test-snapd-content-provider:special-content-basic"
    snap connections test-snapd-content-consumer | MATCH "test-snapd-content-provider:special-content-extra"

    test-snapd-content-consumer.app |& tee output.log
    MATCH 'hello from app' < output.log

    MATCH "connect content extra" < /var/snap/test-snapd-content-consumer/common/hook.log
