summary: Ensure that calling fdehook binaries works

# enough to test this on ubuntu 20.04+
systems: [ubuntu-2*]

environment:
    # an empty $topsrcdir/tests/go.mod seems to break importing or building go
    # packages referenced by their import paths while under the tests directory,
    # need to disable go modules support for this test
    GO111MODULE: off

prepare: |
    tests.cleanup prepare

execute: |
    # build a fde hook runner
    go build run-fdehelper.go

    echo "Run trivial unlock fde hook"
    # create trivial "unlock" fde hook
    mkdir -p fake-initrd-root/bin
    cat > fake-initrd-root/bin/fde-reveal-key <<'EOF'
    #!/bin/sh -e
    echo "$(cat -)"
    env > env.txt
    EOF
    chmod +x fake-initrd-root/bin/fde-reveal-key
    # validate that unlock input/output works
    echo fake-sealed-key | ./run-fdehelper ./fake-initrd-root | MATCH "revealed key"
    # validate that the env passing worked
    MATCH "FDE_*" < env.txt

    echo "Run fde hook at triggers the sandboxing via a mount"
    # create bind mount *target* here (and add cleanup)
    touch /tmp/test-bind-mount
    # the umount should not be needed as the mount will be blocked by seccomp
    tests.cleanup defer "umount /tmp/test-bind-mount || true"
    tests.cleanup defer rm -f "/tmp/test-bind-mount"
    # now validate that mounting is sandboxed
    cat > fake-initrd-root/bin/fde-reveal-key <<'EOF'
    #!/bin/sh -e
    mount -o bind /bin/true /tmp/test-binary
    echo "mount was successful"
    EOF
    set +e
    echo fake-sealed-key | ./run-fdehelper ./fake-initrd-root
    RET=$?
    set -e
    test "$RET" -ne 0
    # no mount was performed
    not test -x /tmp/test-bind-mount

    echo "Run fdehelper that runs too long"
    cat > fake-initrd-root/bin/fde-reveal-key <<'EOF'
    #!/bin/sh -e
    sleep 30
    echo "done sleeping"
    EOF
    set +e
    echo fake-sealed-key | DEBUG_FDEHELPER_RUNTIME_MAX=10s ./run-fdehelper ./fake-initrd-root > output.txt
    RET=$?
    set -e
    test "$RET" -ne 0
    NOMATCH "done sleeping" < output.txt
    MATCH "timeout" < output.txt

restore: |
    tests.cleanup restore
