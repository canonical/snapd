summary: Test that snap-confine is run from core on re-exec

systems: [-ubuntu-core-16-*]

prepare: |
    echo "Installing test-snapd-tools"
    snap install test-snapd-tools
    echo "Breaking host snap-confine"

restore: |
    echo "Restoring host snap-confine"
    chmod 4755 /usr/lib/snapd/snap-confine

execute: |
    if [ "${SNAP_REEXEC:-}" = "0" ]; then
        echo "skipping test when SNAP_REEXEC is disabled"
        exit 0
    fi

    prev_restarts=$(journalctl | grep -c "DEBUG: restarting into")
    chmod 0755 /usr/lib/snapd/snap-confine

    echo "Ensure we re-exec by default"
    snap list

    for i in $(seq 3); do
        after_restarts=$(journalctl | grep -c "DEBUG: restarting into")
        if [ $after_restarts -gt $prev_restarts ]; then
            break
        fi
        sleep 1
    done

    after_restarts=$(journalctl | grep -c "DEBUG: restarting into")
    [ $after_restarts -eq $(( $prev_restarts + 1 )) ]

    echo "Ensure snap-confine from the core snap is run"
    # do not use "strace -f" for unknown reasons that hangs
    test-snapd-tools.echo hello
