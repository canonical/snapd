summary: Check that snaps can use software-watchdog provided by systemd

execute: |
    echo "When the service snap  is installed"
    . $TESTSLIB/snaps.sh
    install_local test-snapd-service-watchdog

    echo "We can see all services running"
    for service in direct-watchdog-ok direct-watchdog-bad; do
        ! systemctl show -p SubState snap.test-snapd-service-watchdog.$service | MATCH "SubState=dead"
    done

    echo "Services that are correctly poking the watchdog remain running"
    for i in $(seq 20); do
        for service in direct-watchdog-ok; do
            systemctl show -p SubState snap.test-snapd-service-watchdog.$service | MATCH 'SubState=running'
        done
        sleep 1
    done

    echo "Services not poking the watchdog fail due to watchdog"
    for service in direct-watchdog-bad; do
        systemctl show -p SubState snap.test-snapd-service-watchdog.$service | MATCH 'SubState=failed'
        systemctl show -p Result snap.test-snapd-service-watchdog.$service | MATCH 'Result=(watchdog|signal)'
        journalctl -u snap.test-snapd-service-watchdog.$service | MATCH 'Watchdog timeout'
    done
