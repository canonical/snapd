summary: Check that snaps can use software-watchdog provided by systemd

execute: |
    echo "When the service snap  is installed"
    . $TESTSLIB/snaps.sh
    install_local test-snapd-service-watchdog

    echo "We can see all services running"
    for service in direct-watchdog-ok direct-watchdog-bad; do
        ! systemctl show -p SubState snap.test-snapd-service-watchdog.$service | MATCH "SubState=dead"
    done

    echo "Services that are correctly poking the watchdog remain running"
    cnt=0
    while true; do
        wdk=$(journalctl -u snap.test-snapd-service-watchdog.direct-watchdog-ok | grep -c 'watchdog kick' || true)
        test "$wdk" -ge 4 && break || true
        cnt=$((cnt + 1))
        test "$cnt" -lt 20
        sleep 1
    done
    systemctl show -p SubState snap.test-snapd-service-watchdog.direct-watchdog-ok | MATCH 'SubState=running'

    echo "Services not poking the watchdog fail due to watchdog"
    for service in direct-watchdog-bad; do
        systemctl show -p SubState snap.test-snapd-service-watchdog.$service | MATCH 'SubState=failed'
        systemctl show -p Result snap.test-snapd-service-watchdog.$service | MATCH 'Result=(watchdog|signal)'
        journalctl -u snap.test-snapd-service-watchdog.$service | MATCH 'Watchdog timeout'
    done
