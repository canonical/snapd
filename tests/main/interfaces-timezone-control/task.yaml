summary: Check that timezone interface works

details: |
    This test makes sure that a snap using the timezone-control interface
    can access timezone information and change it.

prepare: |
    echo "Given a snap declaring a plug on timezone-control is installed"
    snap try $TESTSLIB/snaps/test-snapd-timezone-control-consumer/

    echo "Then the default timezone is saved to be restored"
    timezone=$(timedatectl status | grep 'Time zone:' | sed 's/.*Time zone: \(.*\) (.*)/\1/')
    timedatectl list-timezones | MATCH "^$timezone$"
    echo $timezone > timezone.txt



restore: |
    echo "Finnally restore the initial timezone"
    timedatectl set-timezone "$(cat timezone.txt)"
    rm -f timezone.txt

execute: |
    . $TESTSLIB/dirs.sh

    # Read/write access should be possible
    test -n "`$SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.read`"
    $SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.write
    
    timezone1=$($SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl list-timezones | sed -n 1p)
    timezone2=$($SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl list-timezones | sed -n 2p)

    echo "Set the timezone1 as timezone and check the status"
    $SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl set-timezone $timezone1
    [ $(timedatectl status | grep 'Time zone:' | sed 's/.*Time zone: \(.*\) (.*)/\1/') = $timezone1 ]

    echo "Set the timezone2 as timezone and check the status"
    $SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl set-timezone $timezone2
    [ $(timedatectl status | grep 'Time zone:' | sed 's/.*Time zone: \(.*\) (.*)/\1/') = $timezone2 ]
    [ $($SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl status | grep 'Time zone:' | sed 's/.*Time zone: \(.*\) (.*)/\1/') = $timezone2 ]

    # Read/write access should be possible
    test -n "`$SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl status`"
    $SNAP_MOUNT_DIR/bin/test-snapd-timezone-control-consumer.timedatectl set-local-rtc no
