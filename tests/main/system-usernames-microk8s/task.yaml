summary: ensure only approved snaps can use the microk8s system user

execute: |
    microk8s_snap_path=$("$TESTSTOOLS"/snaps-state pack-local microk8s)
    other_snap_path=$("$TESTSTOOLS"/snaps-state pack-local test-microk8s-username)

    echo "Try to install a snap which is not entitled to use the microk8s user"
    OUT=$(snap install --dangerous "${other_snap_path}" 2>&1 || true)
    echo $OUT | MATCH 'snap "test-microk8s-username" is not allowed to use the system user "snap_microk8s"'

    # Make sure neither snap_microk8s user nor group are created
    not getent passwd snap_microk8s
    not getent group snap_microk8s

    echo "Now install the microk8s snap"
    snap install --dangerous "${microk8s_snap_path}" 2>&1 | MATCH 'microk8s 1.0 installed'

    # Make sure neither snap_microk8s user nor group are created
    getent passwd snap_microk8s
    getent group snap_microk8s
