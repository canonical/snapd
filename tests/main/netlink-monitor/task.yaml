summary: Test netutil/netlink.go

# ubuntu-core: no go-compiler
# ubuntu-16.04-32, debian-9-64:
#   doing "ip link add e8 type veth" gives "RTNETLINK answers: File exists"
#   error
systems: [-ubuntu-core-*, -ubuntu-16.04-32, -debian-9-64]

environment:
    # an empty $topsrcdir/tests/go.mod seems to break importing or building go
    # packages referenced by their import paths while under the tests directory,
    # need to disable go modules supportfor this test
    GO111MODULE: off

prepare: |
    go build -o monitor-default-gw ./monitor.go

restore: |
    systemctl stop monitor-default-gw || true

execute: |
    if ! command -v systemd-run; then
        # SKIP: no systemd-run
        exit 0
    fi
    systemd-run --unit=monitor-default-gw "$(pwd)"/monitor-default-gw

    echo "Do route manipulation"
    ip link add veth28 type veth
    ip link set veth28 up
    ip addr add 192.168.2.2/24 dev veth28
    ip route add default via 192.168.2.1 metric 1000
    ip route del default via 192.168.2.1
    ip addr del 192.168.2.2/24 dev veth28
    ip link del veth28

    echo "Check that both add/remove got captured"
    retry-tool -n 10 sh -c 'journalctl -u monitor-default-gw|MATCH "default gw added 192.168.2.2"'
    retry-tool -n 10 sh -c 'journalctl -u monitor-default-gw|MATCH "default gw removed 192.168.2.2"'
