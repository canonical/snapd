summary: Test netutil/netlink.go

# no go on ubuntu-core
systems: [-ubuntu-core-*]

environment:
    # an empty $topsrcdir/tests/go.mod seems to break importing or building go
    # packages referenced by their import paths while under the tests directory,
    # need to disable go modules supportfor this test
    GO111MODULE: off

prepare: |
    go build -o monitor-default-gw ./monitor.go

restore: |
    systemctl stop monitor-default-gw

execute: |
    if ! command -v systemd-run; then
        # SKIP: no systemd-run
        exit 0
    fi
    systemd-run --unit=monitor-default-gw "$(pwd)"/monitor-default-gw

    echo "Do route manipulation"
    ip link add veth99 type veth
    ip addr add 192.168.2.2/24 dev veth99
    ip route add default via 192.168.2.2
    ip route del default via 192.168.2.2
    ip addr del 192.168.2.2/24 dev veth99

    echo "Check that both add/remove got captured"
    retry-tool -n 10 sh -c 'journalctl -u monitor-default-gw|MATCH "default gw added 192.168.2.2"'
    retry-tool -n 10 sh -c 'journalctl -u monitor-default-gw|MATCH "default gw removed 192.168.2.2"'
