summary: Ensure taht the cups interface works.

details: |
    The cups-control interface allows a snap to access the locale configuration.

    A snap which defines the cups-control plug must be shown in the interfaces list.
    The plug must not be autoconnected on install and, as usual, must be able to be
    reconnected.

    A snap declaring a plug on this interface must be able to talk to the cups daemon.
    The test snap used pulls the lpr functionality and installs a pdf printer. In order
    to actually connect to the socket it needs to declare a plug on the network interface.
    The test checks for the existence of a pdf file generated by the lpr command in the
    snap.

environment:
    BUILD_DIR: $(mktemp -d)
    TEST_FILE: /var/snap/cups-control-consumer/current/test_file.txt

prepare: |
    echo "Given a snap declaring a cups plug is installed"
    apt install -y snapcraft
    mkdir -p $BUILD_DIR
    cp -ar $TESTSLIB/snaps/cups-control-consumer/* $BUILD_DIR
    cd $BUILD_DIR
    snapcraft
    snap install cups-control-consumer_1.0_$(dpkg-architecture -q DEB_HOST_ARCH_CPU).snap
    cd $SPREAD_PATH

    echo "And the pdf printer is available"
    apt install -y printer-driver-cups-pdf

restore: |
    apt remove -y printer-driver-cups-pdf snapcraft
    apt autoremove -y
    rm -rf cups-control-consumer_1.0_$(dpkg-architecture -q DEB_HOST_ARCH_CPU).snap $HOME/PDF $TEST_FILE print.error $BUILD_DIR

execute: |
    CONNECTED_PATTERN=":cups-control +cups-control-consumer"
    DISCONNECTED_PATTERN="(?s).*?\n- +cups-control-consumer:cups-control"

    echo "Then it is not shown as connected"
    snap interfaces | grep -Pzq "$DISCONNECTED_PATTERN"

    echo "===================================="

    echo "When the plug is connected"
    snap connect cups-control-consumer:cups-control ubuntu-core:cups-control
    snap interfaces | grep -Pzq "$CONNECTED_PATTERN"

    echo "Then the snap command is able to print files"
    echo "Hello World" > $TEST_FILE
    cups-control-consumer.lpr $TEST_FILE
    while ! test -e $HOME/PDF/test_file.pdf; do sleep 1; done

    echo "===================================="

    echo "When the plug is disconnected"
    snap disconnect cups-control-consumer:cups-control ubuntu-core:cups-control
    snap interfaces | grep -Pzq "$DISCONNECTED_PATTERN"

    echo "Then the snap command is not able to print files"
    if cups-control-consumer.lpr $TEST_FILE 2>print.error; then
        echo "Expected error with plug disconnected"
        exit 1
    fi
    grep -q "scheduler not responding" print.error
