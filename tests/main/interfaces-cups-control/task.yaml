summary: Ensure taht the cups interface works.

prepare: |
    echo "Given a snap declaring a cups plug is installed"
    apt install -y snapcraft
    tmp_dir=$(mktemp -d)
    cp -ar $TESTSLIB/snaps/cups-control-consumer/* $tmp_dir
    cd $tmp_dir
    snapcraft
    snap install cups-control-consumer_1.0_$(dpkg-architecture -q DEB_HOST_ARCH_CPU).snap
    cd $SPREAD_PATH

    echo "And the pdf printer is available"
    apt install printer-driver-cups-pdf

    echo "And the required dependencies are in place"
    apt install python3-cups

restore: |
    apt remove -y printer-driver-cups-pdf snapcraft
    apt autoremove -y
    rm -rf cups-control-consumer_1.0_$(dpkg-architecture -q DEB_HOST_ARCH_CPU).snap $HOME/PDF test_file.txt print.error

execute: |
    CONNECTED_PATTERN=":cups-control +cups-control-consumer"
    DISCONNECTED_PATTERN="(?s).*?\n- +cups-control-consumer:cups-control"

    echo "Then it is not shown as connected"
    snap interfaces | grep -Pzq "$DISCONNECTED_PATTERN"

    echo "===================================="

    echo "When the plug is connected"
    snap connect cups-control-consumer:cups-control ubuntu-core:cups-control

    echo "Then the snap command is able to print files"
    echo "Hello World" > test_file.txt
    cups-control-consumer.lpr test_file.txt
    [ -f $HOME/PDF/test_file.pdf ]

    echo "===================================="

    echo "When the plug is disconnected"
    snap disconnect cups-control-consumer:cups-control ubuntu-core:cups-control

    echo "Then the snap command is not able to print files"
    if cups-control-consumer.lpr test_file.txt 2>print.error; then
        echo "Expected error with plug disconnected"
        exit 1
    fi
    cat print.error | grep -q "Permission denied"
