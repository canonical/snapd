summary: Check that LXD snap works on a system using SELinux in enforcing mode

details: |
    Make sure that LXD snap can be installed and used on a SELinux enable
    system, with enforcing mode on.

# Systems with SELinux enabled out of the box.
systems: [fedora-*, centos-*]

prepare: |
    getenforce > enforcing.mode
    # Enable enforcing mode, our policy is already marked as permissive, so we
    # will get audit entries but the program will not be stopped by SELinux
    setenforce 1
    ausearch --checkpoint stamp -m AVC || true

restore: |
    # Restore nsdelegate mount option clobbered by LXD.
    if mountinfo.query /sys/fs/cgroup/unified; then
        mount -o remount,nsdelegate /sys/fs/cgroup/unified
    fi

    setenforce "$(cat enforcing.mode)"

    if mountinfo.query /proc/sys/fs/binfmt_misc .fs_type=binfmt_misc; then
        umount /proc/sys/fs/binfmt_misc
    fi

    "$TESTSTOOLS"/lxd-state undo-mount-changes

debug: |
    if [ -e avc-after ]; then
        echo "AVC log from the test"
        cat avc-after
    fi

execute: |
    snap install lxd --channel="$LXD_SNAP_CHANNEL"
    ausearch -i --checkpoint stamp --start checkpoint -m AVC 2>&1 | MATCH 'no matches'

    echo "Create a trivial container using the lxd snap"
    snap set lxd waitready.timeout=240
    lxd waitready
    lxd init --auto

    echo "Setting up proxy for lxc"
    if [ -n "${http_proxy:-}" ]; then
        lxd.lxc config set core.proxy_http "$http_proxy"
    fi
    if [ -n "${https_proxy:-}" ]; then
        lxd.lxc config set core.proxy_https "$http_proxy"
    fi

    lxd.lxc launch --quiet "ubuntu:18.04" my-ubuntu
    if os.query is-pc-amd64 && lxd.lxc info my-ubuntu | grep "Architecture: i686"; then
        echo "LXD spawned 32bit userspace container on a 64bit host, WAT?"
        snap info lxd
        exit 1
    fi

    echo "Ensure we can run things inside"
    lxd.lxc exec my-ubuntu echo hello | MATCH hello

    echo "Stop and remove the container"
    lxd.lxc stop --force my-ubuntu
    lxd.lxc delete --force my-ubuntu

    snap remove lxd

    # there is a known problem with the reference policy that disallows systemd
    # from creating a BPF map for unconfined_service_t, see:
    # https://bugzilla.redhat.com/show_bug.cgi?id=1694115
    #
    # ausearch exits with 1 when there are no denials, which we expect on
    # centos-8, but not on centos-7
    ausearch --checkpoint stamp --start checkpoint -m AVC > avc-after 2>&1 || true
    grep -v -E 'avc:  denied  { map_create } for  pid=[0-9]+ comm="systemd"' < avc-after | \
        NOMATCH 'type=AVC'
