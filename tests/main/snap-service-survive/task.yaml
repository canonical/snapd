summary: "Check that refresh-mode: survive works"

kill-timeout: 5m

execute: |
    echo "When the service snap is installed"
    . $TESTSLIB/snaps.sh
    install_local test-snapd-service

    echo "We can see it running"
    systemctl status snap.test-snapd-service.test-snapd-surviving-service|MATCH "running"

    echo "When it is re-installed"
    install_local test-snapd-service

    echo "We can still see it running"
    systemctl status snap.test-snapd-service.test-snapd-surviving-service|MATCH "running"

    echo "And it is not re-started"
    if journalctl -u snap.test-snapd-service.test-snapd-surviving-service | grep "stop survive"; then
       echo "reinstall did stop a service that should survive"
       exit 1
    fi

    echo "But regular services are restarted"
    journalctl -u snap.test-snapd-service.test-snapd-service | MATCH "stop service"

    echo "Once the snap is removed, the service is stopped"
    snap remove test-snapd-service
    journalctl | MATCH "stop survive"