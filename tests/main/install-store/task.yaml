summary: Checks for special cases of snap install from the store

systems: [ubuntu-core-16-*]

environment:
    SNAP_NAME: test-snapd-tools
    DEVMODE_SNAP: test-snapd-devmode
    # Ensure that running purely from the deb (without re-exec) works
    # correctly
    SNAP_REEXEC/reexec0: 0
    SNAP_REEXEC/reexec1: 1

execute: |
    echo "Install from different channels"
    expected="(?s)$SNAP_NAME .* from 'canonical' installed\n"
    for channel in edge beta candidate stable
    do
        snap install $SNAP_NAME --channel=$channel | grep -Pzq "$expected"
        snap remove $SNAP_NAME
    done

    echo "Install non-devmode snap with devmode option"
    expected="(?s)$SNAP_NAME .* from 'canonical' installed\n"
    snap install $SNAP_NAME --devmode | grep -Pzq "$expected"

    echo "Install devmode snap without devmode option"
    ( snap install --channel beta $DEVMODE_SNAP 2>&1 && exit 1 || true ) | MATCH "requires devmode or confinement override"

    echo "Install devmode snap from stable"
    expected="snap not found"
    actual=$(snap install --devmode $DEVMODE_SNAP 2>&1 && exit 1 || true)
    echo "$actual" | grep -Pzq "$expected"

    echo "Install devmode snap from beta with devmode option"
    expected="(?s)$DEVMODE_SNAP .*"
    actual=$(snap install --channel beta --devmode $DEVMODE_SNAP)
    echo "$actual" | grep -Pzq "$expected"
