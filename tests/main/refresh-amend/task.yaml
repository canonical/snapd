summary: Ensure that refresh --amend works

restore: |
    rm -f test-snapd-only-in-edge_*.snap

execute: |
    echo "When installing a local snap"
    snap download --edge test-snapd-only-in-edge
    snap install --dangerous ./test-snapd-only-in-edge_*.snap
    snap list |MATCH "test-snapd-only-in-edge.*x1"

    echo "A normal refresh will not refresh it to the store rev"
    if snap refresh test-snapd-only-in-edge 2> stderr.out; then
        echo "snap refresh should error but did not"
        exit 1
    fi
    cat stderr.out | MATCH 'local snap "test-snapd-only-in-edge" is unknown to the store'

    echo "A refresh with --amend is not enough, the channel needs to be added"
    if snap refresh --amend test-snapd-only-in-edge 2> stderr.out; then
       echo "snap refresh --amend without --edge should error but it did not"
       exit 1
    fi
 
    echo "A refresh with --amend refreshes it to the store revision"
    snap refresh --edge --amend test-snapd-only-in-edge
    echo "And we have a store revision now"
    snap info test-snapd-only-in-edge | MATCH "^snap-id:.*[a-zA-Z0-9]+$"
