summary: Test the snapctl feature handshake

details: |
  Verifies that the snapctl feature handshake works by monitoring the PID
  of a snap that snapctl is running inside of. Using strace, the syscalls
  made by snapctl are monitored to check for the features header, which tells the
  daemon which features snapctl supports.

prepare: |
    "$TESTSTOOLS"/snaps-state install-local test-snapd-sh-core24

restore: |
    snap remove --purge test-snapd-sh-core24

execute: |
    snap run --strace="-s 10000 -e trace=write" test-snapd-sh.sh -c "snapctl refresh --tracking" > trace.log 2>&1

    cat trace.log | MATCH "/v2/snapctl"

    # TODO update this test later to check specific features
    cat trace.log | MATCH "X-Snapctl-Features:"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   