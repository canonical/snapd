#!/usr/bin/sh -e

# Only works when run as root. Rather than set up a daemon, just assume the
# caller will be root in the spread VM, and check that snap confinement only
# lets this work when the audit_control capability is set.

# Check initial capabilities
initial="$(capsh --current)"
echo "$initial"

# root defaults to `=ep`, so set audit control to have 'i' (inheritable) as well.
# See capsh(1) and cap_from_text(3) for more details.
altered="$(capsh --caps=cap_audit_control=ipe '==' --current)"
echo "$altered"

if [ "$initial" = "$altered" ] ; then
	echo "ERROR: setting capabilities had no effect: $initial"
	exit 1
fi
