summary: Check that try command works inside lxd container

details: |
  Verifies that the `snap try` command works inside a LXD container.

systems: [ubuntu-2*]

skip:
    - reason: Requires snapd .deb files built for testing
      if: |
        # "$GOHOME"/snapd_*.deb is used in the lxd container
        [[ "$(find "$GOHOME" -name 'snapd_*.deb' | wc -l || echo 0)" -eq 0 ]]

prepare: |
  echo "Install lxd"
  "$TESTSTOOLS"/lxd-state prepare-snap
  "$TESTSTOOLS"/lxd-state launch --name ubuntu

  # wait for the container to be fully up
  # the retry is needed because of the error "Failed to connect to bus: No such file or directory"
  retry --wait 1 -n 10 sh -c 'lxd.lxc exec ubuntu -- systemctl --wait is-system-running | grep -Eq "(running|degraded)"'

  lxd.lxc file push --quiet "$GOHOME"/snapd_*.deb "ubuntu/root/"
  DEB=$(basename "$GOHOME"/snapd_*.deb)
  lxd.lxc exec ubuntu -- apt update
  lxd.lxc exec ubuntu -- apt install -y /root/"$DEB"
  lxd.lxc file push -r --quiet "$TESTSLIB"/snaps/test-snapd-tools "ubuntu/root/"

restore: |
  lxd.lxc stop ubuntu --force || true
  lxd.lxc delete ubuntu || true
  snap remove --purge lxd

execute: |
  lxd.lxc exec ubuntu -- snap try /root/test-snapd-tools
  lxd.lxc exec ubuntu -- snap list | MATCH '^test-snapd-tools .* try'
