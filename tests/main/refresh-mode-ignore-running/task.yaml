summary: apps can request not to be tracked

systems: [-ubuntu-14.04-*]

prepare: |
  snap set system experimental.refresh-app-awareness=true
  snap pack test-snapd-refresh
  snap install --dangerous ./test-snapd-refresh_1_all.snap

restore: |
  snap remove --purge test-snapd-refresh
  rm -f test-snapd-refresh_1.all.snap
  snap unset system experimental.refresh-app-awareness

execute: |
  tests.cleanup defer rm -f stamp

  trap 'touch stamp' EXIT

  test-snapd-refresh.sh -c "while [ ! -e stamp ]; do sleep 1; done" &
  not snap install --dangerous ./test-snapd-refresh_1_all.snap
  touch stamp
  wait

  rm -f stamp

  test-snapd-refresh.refresh-allowed-sh -c "while [ ! -e stamp ]; do sleep 1; done" &
  snap install --dangerous ./test-snapd-refresh_1_all.snap
  touch stamp
  wait
