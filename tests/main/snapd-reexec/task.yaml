summary: Test that snapd rexecs itself into core

systems: [-ubuntu-core-16-64, -ubuntu-core-16-arm-64, -ubuntu-core-16-arm-32]

environment:
    SNAPD_CONF: /etc/systemd/system/snapd.service.d/local.conf 

debug: |
    cat /var/log/syslog

execute: |
    echo "Ensure we re-exec by default"
    grep "restarting into" /var/log/syslog
  
    systemctl stop snapd.service snapd.socket
    echo "mount something older than our freshly build snapd"
    mount --bind /bin/true /snap/core/current/usr/lib/snapd/snapd
    systemctl start snapd.service snapd.socket
    
    echo "Ensure that we do not re-exec into older versions"
    snap list
    grep "not restarting into.*older than" /var/log/syslog

    systemctl stop snapd.service snapd.socket
    umount /snap/core/current/usr/lib/snapd/snapd

    # FIMXE: add test for SNAP_REXEC=0
    