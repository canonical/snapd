summary: Ensure that the gsettings interface works.

details: |
    The gsettings interface allows to access the gsettings.

execute: |
    CONNECTED_PATTERN=":gsettings +test-snapd-gsettings"
    DISCONNECTED_PATTERN="\- +test-snapd-gsettings:gsettings"

    echo "The plug is not connected by default"
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "When the plug is connected"
    snap try $TESTSLIB/snaps/test-snapd-gsettings
    snap interfaces | MATCH "$CONNECTED_PATTERN"

    echo "Then the snap is able to list schemas"
    schema=$(gsettings list-schemas | head -n1)
    test-snapd-gsettings.check-schema $schema

    echo "When the plug is disconnected"
    snap disconnect test-snapd-gsettings:gsettings
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "Then the snap is not able to access the provided methods"
    if test-snapd-gsettings.check-schema $schema 2>${PWD}/call.error; then
        echo "Expected permission error calling gsettings with disconnected plug"
        exit 1
    fi
    MATCH "Permission denied" < call.error