summary: ensure seccomp rules for snap_daemon user work correctly

environment:
    # This is used to abbreviate some of the paths below.
    P1: /var/snap/test-snapd-sh/common/test.chown
    P2: /var/snap/test-snapd-daemon-user/common/test.chown
    P3: /var/snap/test-snapd-daemon-user/common/test.chown32
    # List of expected snap install failures due to libseccomp/golang-seccomp
    # being too old. This should only reduce with time since new systems should
    # have newer libseccomp and golang-seccomp
    EXFAIL: "centos-7-64 debian-9-64 debian-10-64 opensuse-15\\.0-64 ubuntu-14"

prepare: |
    echo "Install helper snaps with default confinement"
    "$TESTSTOOLS"/snaps-state install-local test-snapd-sh

restore: |
    # make sure this snap is removed in case it was installed
    snap remove --purge test-snapd-daemon-user || true

    # snapd will create this for us, but we'll remove it for consistency in
    # test runs
    "$TESTSTOOLS"/user-state remove-with-group snap_daemon

execute: |
    # to accommodate different distros, we pick the LSB required 'daemon' user
    # to verify 'chown' doesn't work with arbitrary users
    getent passwd daemon || exit 1
    getent group daemon || exit 1

    # expect a seccomp denial with 'chown' operation
    echo "Running 'chown' without any system-usernames"
    touch "$P1"
    snap run test-snapd-sh.sh -c "chown daemon:daemon $P1" 2>&1 | MATCH 'Operation not permitted'

    # We want this test to run on all systems since the end goal is for all
    # systems that have a new enough libseccomp (>= 2.4.0) and golang-seccomp
    # (with ActLog support, or >= 0.9.1) to show the feature is enabled, and
    # those not meeting these criteria to show the feature as disabled. We can
    # check for support in an existing snap's seccomp profile header, then go
    # from there.
    supported="no"
    header=$(head -2 /var/lib/snapd/seccomp/bpf/snap.test-snapd-sh.sh.src | grep -A1 'snap-seccomp version information' | tail -1)
    echo "snap-seccomp version information is '$header'"
    if [ -n "$header" ]; then
        features=$(echo "$header" | cut -d ' ' -f 5)
        if echo "$features" | grep -q "bpf-actlog" ; then
            maj=$(echo "$header" | cut -d ' ' -f 3 | cut -d '.' -f 1)
            min=$(echo "$header" | cut -d ' ' -f 3 | cut -d '.' -f 2)
            if [ "$maj" -gt 2 ]; then
                supported="yes"
            elif [ "$maj" -eq 2 ] && [ "$min" -ge 4 ]; then
                supported="yes"
            fi
        fi
    fi

    ok_to_fail="no"
    for regex in $EXFAIL ; do
        if echo "$SPREAD_SYSTEM" | grep -Eq "$regex" ; then
            ok_to_fail="yes"
            break
        fi
    done
    if [ "$supported" = "no" ] && [ "$ok_to_fail" = "no" ]; then
            # Fail if have no support when we should
            echo "'$SPREAD_SYSTEM' does not have support when it should!!"
            exit 1
    elif [ "$supported" = "yes" ] && [ "$ok_to_fail" = "yes" ]; then
        # if an old system gains, make sure we notice and adjust to not regress
        # in the future
        if [ "$ok_to_fail" = "yes" ]; then
            echo "'$SPREAD_SYSTEM' now has support. Please update this test"
            exit 1
        fi
    fi

    # Now try to install the test snap. If we don't have support, we expect an
    # error, if we do, then we can proceed
    if [ "$supported" = "yes" ]; then
        snap install --edge test-snapd-daemon-user
    else
        snap install --edge test-snapd-daemon-user 2>&1 | MATCH 'require a snapd built against (libseccomp >= 2.4|golang-seccomp >= 0.9.1)'
        exit 0
    fi

    echo "Verify the snap_daemon user and group was created with the expected uid/gid"
    user=$(getent passwd snap_daemon | cut -d : -f 3)
    test "$user" -eq "584788" || exit 1
    group=$(getent group snap_daemon | cut -d : -f 3)
    test "$group" -eq "584788" || exit 1

    #
    # Test typical drop operations though libc and raw syscalls
    #
    echo "Running 'drop' with system-usernames: [ snap_daemon ] as non-root"
    # CAP_SETGID is dropped before running
    su -l -c "snap run test-snapd-daemon-user.drop snap_daemon" test 2>&1   | MATCH 'Operation not permitted'
    su -l -c "snap run test-snapd-daemon-user.drop32 snap_daemon" test 2>&1 | MATCH 'Operation not permitted'

    echo "Running 'drop' with system-usernames: [ snap_daemon ] as root"
    snap run test-snapd-daemon-user.drop snap_daemon 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=$group, egid=$group, sgid=$group, groups=$"
    snap run test-snapd-daemon-user.drop32 snap_daemon 2>&1 | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=$group, egid=$group, sgid=$group, groups=$"

    echo "Running 'drop-syscall' with system-usernames: [ snap_daemon ] as non-root"
    # CAP_SETGID is dropped before running
    su -l -c "snap run test-snapd-daemon-user.drop-syscall snap_daemon" test 2>&1   | MATCH 'Operation not permitted'
    su -l -c "snap run test-snapd-daemon-user.drop-syscall32 snap_daemon" test 2>&1 | MATCH 'Operation not permitted'

    echo "Running 'drop-syscall' with system-usernames: [ snap_daemon ] as root"
    snap run test-snapd-daemon-user.drop-syscall snap_daemon 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=$group, egid=$group, sgid=$group, groups=$"
    snap run test-snapd-daemon-user.drop-syscall32 snap_daemon 2>&1 | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=$group, egid=$group, sgid=$group, groups=$"

    #
    # test individual seccomp rules
    #
    echo "Testing individual syscalls"

    # setgid
    echo "'setgid g:root' allowed"
    snap run test-snapd-daemon-user.setgid root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setgid32 root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setgid g:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setgid snap_daemon 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="
    snap run test-snapd-daemon-user.setgid32 snap_daemon 2>&1 | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="

    echo "'setgid g:test' denied"
    snap run test-snapd-daemon-user.setgid test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setgid32 test 2>&1   | MATCH "Operation not permitted"


    # setregid
    echo "'setregid g:root g:root' allowed"
    snap run test-snapd-daemon-user.setregid root root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 root root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setregid -1 g:root' allowed"
    snap run test-snapd-daemon-user.setregid -1 root 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 -1 root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setregid g:root -1' allowed"
    snap run test-snapd-daemon-user.setregid root -1 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 root -1 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setregid g:snap_daemon g:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setregid snap_daemon snap_daemon 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="
    snap run test-snapd-daemon-user.setregid32 snap_daemon snap_daemon 2>&1 | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="

    echo "'setregid -1 g:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setregid -1 snap_daemon 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=$group, groups="
    snap run test-snapd-daemon-user.setregid32 -1 snap_daemon 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=$group, groups="

    echo "'setregid g:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setregid snap_daemon -1 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 snap_daemon -1 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="

    echo "'setregid g:root g:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setregid root snap_daemon 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=$group, groups="
    snap run test-snapd-daemon-user.setregid32 root snap_daemon 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=$group, groups="

    echo "'setregid g:snap_daemon g:root' allowed"
    snap run test-snapd-daemon-user.setregid snap_daemon root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 snap_daemon root 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="

    echo "'setregid g:test g:test' denied"
    snap run test-snapd-daemon-user.setregid test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 test test 2>&1     | MATCH "Operation not permitted"

    echo "'setregid -1 g:test' denied"
    snap run test-snapd-daemon-user.setregid -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'setregid g:test -1' denied"
    snap run test-snapd-daemon-user.setregid test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 test -1 2>&1       | MATCH "Operation not permitted"

    echo "'setregid g:root g:test' denied"
    snap run test-snapd-daemon-user.setregid root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 root test 2>&1     | MATCH "Operation not permitted"

    echo "'setregid g:test g:root' denied"
    snap run test-snapd-daemon-user.setregid test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 test root 2>&1     | MATCH "Operation not permitted"

    echo "'setregid g:snap_daemon g:test' denied"
    snap run test-snapd-daemon-user.setregid snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 snap_daemon test 2>&1   | MATCH "Operation not permitted"

    echo "'setregid g:test g:snap_daemon' denied"
    snap run test-snapd-daemon-user.setregid test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setregid32 test snap_daemon 2>&1   | MATCH "Operation not permitted"


    # setresgid
    echo "'setresgid g:root g:root g:root' allowed"
    snap run test-snapd-daemon-user.setresgid root root root 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 root root root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresgid -1 g:root -1' allowed"
    snap run test-snapd-daemon-user.setresgid -1 root -1 2>&1             | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 -1 root -1 2>&1           | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresgid g:root g:root -1' allowed"
    snap run test-snapd-daemon-user.setresgid root root -1 2>&1           | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 root root -1 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresgid g:snap_daemon g:snap_daemon g:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setresgid snap_daemon snap_daemon snap_daemon 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="
    snap run test-snapd-daemon-user.setresgid32 snap_daemon snap_daemon snap_daemon 2>&1 | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=$group, groups="

    echo "'setresgid -1 g:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setresgid -1 snap_daemon -1 2>&1           | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 -1 snap_daemon -1 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=$group, sgid=0, groups="

    echo "'setresgid g:snap_daemon g:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setresgid snap_daemon snap_daemon -1 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 snap_daemon snap_daemon -1 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=0, groups="

    echo "'setresgid g:snap_daemon g:snap_daemon g:root' allowed"
    snap run test-snapd-daemon-user.setresgid snap_daemon snap_daemon root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=0, groups="
    snap run test-snapd-daemon-user.setresgid32 snap_daemon snap_daemon root 2>&1   | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=$group, sgid=0, groups="

    echo "'setresgid g:snap_daemon g:root g:root' allowed"
    snap run test-snapd-daemon-user.setresgid snap_daemon root root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setregid32 snap_daemon root root 2>&1      | MATCH "After: ruid=0, euid=0, suid=0, rgid=$group, egid=0, sgid=0, groups="

    echo "'setresgid -1 -1 g:test' denied"
    snap run test-snapd-daemon-user.setresgid -1 -1 test 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 -1 -1 test 2>&1           | MATCH "Operation not permitted"

    echo "'setresgid -1 g:test -1' denied"
    snap run test-snapd-daemon-user.setresgid -1 test -1 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 -1 test -1 2>&1           | MATCH "Operation not permitted"

    echo "'setresgid -1 g:test g:test' denied"
    snap run test-snapd-daemon-user.setresgid -1 test test 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 -1 test test 2>&1         | MATCH "Operation not permitted"

    echo "'setresgid g:test -1 -1' denied"
    snap run test-snapd-daemon-user.setresgid test -1 -1 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test -1 -1 2>&1           | MATCH "Operation not permitted"

    echo "'setresgid g:test -1 g:test' denied"
    snap run test-snapd-daemon-user.setresgid test -1 test 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test -1 test 2>&1         | MATCH "Operation not permitted"

    echo "'setresgid g:test g:test -1' denied"
    snap run test-snapd-daemon-user.setresgid test test -1 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test test -1 2>&1         | MATCH "Operation not permitted"

    echo "'setresgid g:test g:test g:test' denied"
    snap run test-snapd-daemon-user.setresgid test test test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test test test 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:root g:root g:test' denied"
    snap run test-snapd-daemon-user.setresgid root root test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 root root test 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:root g:test g:root' denied"
    snap run test-snapd-daemon-user.setresgid root test root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 root test root 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:root g:test g:test' denied"
    snap run test-snapd-daemon-user.setresgid root test test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 root test test 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:test g:root g:root' denied"
    snap run test-snapd-daemon-user.setresgid test root root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test root root 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:test g:root g:test' denied"
    snap run test-snapd-daemon-user.setresgid test root test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test root test 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:test g:test g:root' denied"
    snap run test-snapd-daemon-user.setresgid test test root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test test root 2>&1       | MATCH "Operation not permitted"

    echo "'setresgid g:snap_daemon g:snap_daemon g:test' denied"
    snap run test-snapd-daemon-user.setresgid snap_daemon snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 snap_daemon snap_daemon test 2>&1   | MATCH "Operation not permitted"

    echo "'setresgid g:snap_daemon g:test g:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresgid snap_daemon test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 snap_daemon test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'setresgid g:snap_daemon g:test g:test' denied"
    snap run test-snapd-daemon-user.setresgid snap_daemon test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 snap_daemon test test 2>&1     | MATCH "Operation not permitted"

    echo "'setresgid g:test g:snap_daemon g:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresgid test snap_daemon snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test snap_daemon snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'setresgid g:test g:snap_daemon g:test' denied"
    snap run test-snapd-daemon-user.setresgid test snap_daemon test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test snap_daemon test 2>&1     | MATCH "Operation not permitted"

    echo "'setresgid g:test g:test g:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresgid test test snap_daemon 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresgid32 test test snap_daemon 2>&1     | MATCH "Operation not permitted"


    # setuid
    echo "'setuid u:root' allowed"
    snap run test-snapd-daemon-user.setuid root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setuid32 root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setuid u:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setuid snap_daemon 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setuid32 snap_daemon 2>&1 | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="

    echo "'setuid u:test' denied"
    snap run test-snapd-daemon-user.setuid test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setuid32 test 2>&1   | MATCH "Operation not permitted"


    # setreuid
    echo "'setreuid u:root u:root' allowed"
    snap run test-snapd-daemon-user.setreuid root root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 root root 2>&1     | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid -1 u:root' allowed"
    snap run test-snapd-daemon-user.setreuid -1 root 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 -1 root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:root -1' allowed"
    snap run test-snapd-daemon-user.setreuid root -1 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 root -1 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:snap_daemon u:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setreuid snap_daemon snap_daemon 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 snap_daemon snap_daemon 2>&1 | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid -1 u:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setreuid -1 snap_daemon 2>&1       | MATCH "After: ruid=0, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 -1 snap_daemon 2>&1     | MATCH "After: ruid=0, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setreuid snap_daemon -1 2>&1       | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 snap_daemon -1 2>&1     | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:root u:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setreuid root snap_daemon 2>&1     | MATCH "After: ruid=0, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 root snap_daemon 2>&1   | MATCH "After: ruid=0, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:snap_daemon u:root' allowed"
    snap run test-snapd-daemon-user.setreuid snap_daemon root 2>&1     | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 snap_daemon root 2>&1   | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setreuid u:test u:test' denied"
    snap run test-snapd-daemon-user.setreuid test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 test test 2>&1     | MATCH "Operation not permitted"

    echo "'setreuid -1 u:test' denied"
    snap run test-snapd-daemon-user.setreuid -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'setreuid u:test -1' denied"
    snap run test-snapd-daemon-user.setreuid test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 test -1 2>&1       | MATCH "Operation not permitted"

    echo "'setreuid u:root u:test' denied"
    snap run test-snapd-daemon-user.setreuid root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 root test 2>&1     | MATCH "Operation not permitted"

    echo "'setreuid u:test u:root' denied"
    snap run test-snapd-daemon-user.setreuid test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 test root 2>&1     | MATCH "Operation not permitted"

    echo "'setreuid u:snap_daemon u:test' denied"
    snap run test-snapd-daemon-user.setreuid snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 snap_daemon test 2>&1   | MATCH "Operation not permitted"

    echo "'setreuid u:test u:snap_daemon' denied"
    snap run test-snapd-daemon-user.setreuid test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setreuid32 test snap_daemon 2>&1   | MATCH "Operation not permitted"


    # setresuid
    echo "'setresuid u:root u:root u:root' allowed"
    snap run test-snapd-daemon-user.setresuid root root root 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 root root root 2>&1       | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid -1 u:root -1' allowed"
    snap run test-snapd-daemon-user.setresuid -1 root -1 2>&1             | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 -1 root -1 2>&1           | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid u:root u:root -1' allowed"
    snap run test-snapd-daemon-user.setresuid root root -1 2>&1           | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 root root -1 2>&1         | MATCH "After: ruid=0, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid u:snap_daemon u:snap_daemon u:snap_daemon' allowed"
    snap run test-snapd-daemon-user.setresuid snap_daemon snap_daemon snap_daemon 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 snap_daemon snap_daemon snap_daemon 2>&1 | MATCH "After: ruid=$user, euid=$user, suid=$user, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid -1 u:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setresuid -1 snap_daemon -1 2>&1           | MATCH "After: ruid=0, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 -1 snap_daemon -1 2>&1         | MATCH "After: ruid=0, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid u:snap_daemon u:snap_daemon -1' allowed"
    snap run test-snapd-daemon-user.setresuid snap_daemon snap_daemon -1 2>&1       | MATCH "After: ruid=$user, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 snap_daemon snap_daemon -1 2>&1     | MATCH "After: ruid=$user, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid u:snap_daemon u:snap_daemon u:root' allowed"
    snap run test-snapd-daemon-user.setresuid snap_daemon snap_daemon root 2>&1     | MATCH "After: ruid=$user, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setresuid32 snap_daemon snap_daemon root 2>&1   | MATCH "After: ruid=$user, euid=$user, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid u:snap_daemon u:root u:root' allowed"
    snap run test-snapd-daemon-user.setresuid snap_daemon root root 2>&1       | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="
    snap run test-snapd-daemon-user.setreuid32 snap_daemon root root 2>&1      | MATCH "After: ruid=$user, euid=0, suid=0, rgid=0, egid=0, sgid=0, groups="

    echo "'setresuid -1 -1 u:test' denied"
    snap run test-snapd-daemon-user.setresuid -1 -1 test 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 -1 -1 test 2>&1           | MATCH "Operation not permitted"

    echo "'setresuid -1 u:test -1' denied"
    snap run test-snapd-daemon-user.setresuid -1 test -1 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 -1 test -1 2>&1           | MATCH "Operation not permitted"

    echo "'setresuid -1 u:test u:test' denied"
    snap run test-snapd-daemon-user.setresuid -1 test test 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 -1 test test 2>&1         | MATCH "Operation not permitted"

    echo "'setresuid u:test -1 -1' denied"
    snap run test-snapd-daemon-user.setresuid test -1 -1 2>&1             | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test -1 -1 2>&1           | MATCH "Operation not permitted"

    echo "'setresuid u:test -1 u:test' denied"
    snap run test-snapd-daemon-user.setresuid test -1 test 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test -1 test 2>&1         | MATCH "Operation not permitted"

    echo "'setresuid u:test u:test -1' denied"
    snap run test-snapd-daemon-user.setresuid test test -1 2>&1           | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test test -1 2>&1         | MATCH "Operation not permitted"

    echo "'setresuid u:test u:test u:test' denied"
    snap run test-snapd-daemon-user.setresuid test test test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test test test 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:root u:root u:test' denied"
    snap run test-snapd-daemon-user.setresuid root root test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 root root test 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:root u:test u:root' denied"
    snap run test-snapd-daemon-user.setresuid root test root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 root test root 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:root u:test u:test' denied"
    snap run test-snapd-daemon-user.setresuid root test test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 root test test 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:test u:root u:root' denied"
    snap run test-snapd-daemon-user.setresuid test root root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test root root 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:test u:root u:test' denied"
    snap run test-snapd-daemon-user.setresuid test root test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test root test 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:test u:test u:root' denied"
    snap run test-snapd-daemon-user.setresuid test test root 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test test root 2>&1       | MATCH "Operation not permitted"

    echo "'setresuid u:snap_daemon u:snap_daemon u:test' denied"
    snap run test-snapd-daemon-user.setresuid snap_daemon snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 snap_daemon snap_daemon test 2>&1   | MATCH "Operation not permitted"

    echo "'setresuid u:snap_daemon u:test u:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresuid snap_daemon test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 snap_daemon test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'setresuid u:snap_daemon u:test u:test' denied"
    snap run test-snapd-daemon-user.setresuid snap_daemon test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 snap_daemon test test 2>&1     | MATCH "Operation not permitted"

    echo "'setresuid u:test u:snap_daemon u:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresuid test snap_daemon snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test snap_daemon snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'setresuid u:test u:snap_daemon u:test' denied"
    snap run test-snapd-daemon-user.setresuid test snap_daemon test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test snap_daemon test 2>&1     | MATCH "Operation not permitted"

    echo "'setresuid u:test u:test u:snap_daemon' denied"
    snap run test-snapd-daemon-user.setresuid test test snap_daemon 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.setresuid32 test test snap_daemon 2>&1     | MATCH "Operation not permitted"


    # chown
    touch "$P2" "$P3"

    echo "'chown - u:root g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" root root 2>&1       | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.chown32 "$P3" root root 2>&1     | MATCH "After: .* uid=0, gid=0"

    echo "'chown - u:root -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" root -1 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.chown32 "$P3" root -1 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'chown - -1 g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" -1 root 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.chown32 "$P3" -1 root 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'chown - u:snap_daemon g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" snap_daemon snap_daemon 2>&1   | MATCH "After: .* uid=$user, gid=$group"
    snap run test-snapd-daemon-user.chown32 "$P3" snap_daemon snap_daemon 2>&1 | MATCH "After: .* uid=$user, gid=$group"

    echo "'chown - u:snap_daemon -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" snap_daemon -1 2>&1       | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.chown32 "$P3" snap_daemon -1 2>&1     | MATCH "After: .* uid=$user, gid=0"

    echo "'chown - -1 g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" -1 snap_daemon 2>&1       | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.chown32 "$P3" -1 snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"

    echo "'chown - u:snap_daemon g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" snap_daemon root 2>&1     | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.chown32 "$P3" snap_daemon root 2>&1   | MATCH "After: .* uid=$user, gid=0"

    echo "'chown - u:root g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" root snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.chown32 "$P3" root snap_daemon 2>&1   | MATCH "After: .* uid=0, gid=$group"

    echo "'chown - u:test g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" test test 2>&1     | MATCH "Operation not permitted"

    echo "'chown - -1 g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'chown - u:test -1' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" test -1 2>&1       | MATCH "Operation not permitted"

    echo "'chown - u:test g:root' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" test root 2>&1     | MATCH "Operation not permitted"

    echo "'chown - u:root g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" root test 2>&1     | MATCH "Operation not permitted"

    echo "'chown - u:test g:snap_daemon' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'chown - u:snap_daemon g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.chown "$P2" snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.chown32 "$P3" snap_daemon test 2>&1   | MATCH "Operation not permitted"


    # lchown
    echo "'lchown - u:root g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" root root 2>&1       | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.lchown32 "$P3" root root 2>&1     | MATCH "After: .* uid=0, gid=0"

    echo "'lchown - u:root -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" root -1 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.lchown32 "$P3" root -1 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'lchown - -1 g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" -1 root 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.lchown32 "$P3" -1 root 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'lchown - u:snap_daemon g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" snap_daemon snap_daemon 2>&1   | MATCH "After: .* uid=$user, gid=$group"
    snap run test-snapd-daemon-user.lchown32 "$P3" snap_daemon snap_daemon 2>&1 | MATCH "After: .* uid=$user, gid=$group"

    echo "'lchown - u:snap_daemon -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" snap_daemon -1 2>&1       | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.lchown32 "$P3" snap_daemon -1 2>&1     | MATCH "After: .* uid=$user, gid=0"

    echo "'lchown - -1 g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" -1 snap_daemon 2>&1       | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.lchown32 "$P3" -1 snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"

    echo "'lchown - u:snap_daemon g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" snap_daemon root 2>&1     | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.lchown32 "$P3" snap_daemon root 2>&1   | MATCH "After: .* uid=$user, gid=0"

    echo "'lchown - u:root g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" root snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.lchown32 "$P3" root snap_daemon 2>&1   | MATCH "After: .* uid=0, gid=$group"

    echo "'lchown - u:test g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" test test 2>&1     | MATCH "Operation not permitted"

    echo "'lchown - -1 g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'lchown - u:test -1' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" test -1 2>&1       | MATCH "Operation not permitted"

    echo "'lchown - u:test g:root' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" test root 2>&1     | MATCH "Operation not permitted"

    echo "'lchown - u:root g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" root test 2>&1     | MATCH "Operation not permitted"

    echo "'lchown - u:test g:snap_daemon' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'lchown - u:snap_daemon g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.lchown "$P2" snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.lchown32 "$P3" snap_daemon test 2>&1   | MATCH "Operation not permitted"


    # fchown
    echo "'fchown - u:root g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" root root 2>&1       | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchown32 "$P3" root root 2>&1     | MATCH "After: .* uid=0, gid=0"

    echo "'fchown - u:root -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" root -1 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchown32 "$P3" root -1 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'fchown - -1 g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" -1 root 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchown32 "$P3" -1 root 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'fchown - u:snap_daemon g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" snap_daemon snap_daemon 2>&1   | MATCH "After: .* uid=$user, gid=$group"
    snap run test-snapd-daemon-user.fchown32 "$P3" snap_daemon snap_daemon 2>&1 | MATCH "After: .* uid=$user, gid=$group"

    echo "'fchown - u:snap_daemon -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" snap_daemon -1 2>&1       | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.fchown32 "$P3" snap_daemon -1 2>&1     | MATCH "After: .* uid=$user, gid=0"

    echo "'fchown - -1 g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" -1 snap_daemon 2>&1       | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.fchown32 "$P3" -1 snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"

    echo "'fchown - u:snap_daemon g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" snap_daemon root 2>&1     | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.fchown32 "$P3" snap_daemon root 2>&1   | MATCH "After: .* uid=$user, gid=0"

    echo "'fchown - u:root g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" root snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.fchown32 "$P3" root snap_daemon 2>&1   | MATCH "After: .* uid=0, gid=$group"

    echo "'fchown - u:test g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" test test 2>&1     | MATCH "Operation not permitted"

    echo "'fchown - -1 g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'fchown - u:test -1' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" test -1 2>&1       | MATCH "Operation not permitted"

    echo "'fchown - u:test g:root' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" test root 2>&1     | MATCH "Operation not permitted"

    echo "'fchown - u:root g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" root test 2>&1     | MATCH "Operation not permitted"

    echo "'fchown - u:test g:snap_daemon' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'fchown - u:snap_daemon g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchown "$P2" snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchown32 "$P3" snap_daemon test 2>&1   | MATCH "Operation not permitted"


    # fchownat
    echo "'fchownat - u:root g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" root root 2>&1       | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchownat32 "$P3" root root 2>&1     | MATCH "After: .* uid=0, gid=0"

    echo "'fchownat - u:root -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" root -1 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchownat32 "$P3" root -1 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'fchownat - -1 g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" -1 root 2>&1         | MATCH "After: .* uid=0, gid=0"
    snap run test-snapd-daemon-user.fchownat32 "$P3" -1 root 2>&1       | MATCH "After: .* uid=0, gid=0"

    echo "'fchownat - u:snap_daemon g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" snap_daemon snap_daemon 2>&1   | MATCH "After: .* uid=$user, gid=$group"
    snap run test-snapd-daemon-user.fchownat32 "$P3" snap_daemon snap_daemon 2>&1 | MATCH "After: .* uid=$user, gid=$group"

    echo "'fchownat - u:snap_daemon -1' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" snap_daemon -1 2>&1       | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.fchownat32 "$P3" snap_daemon -1 2>&1     | MATCH "After: .* uid=$user, gid=0"

    echo "'fchownat - -1 g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" -1 snap_daemon 2>&1       | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.fchownat32 "$P3" -1 snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"

    echo "'fchownat - u:snap_daemon g:root' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" snap_daemon root 2>&1     | MATCH "After: .* uid=$user, gid=0"
    snap run test-snapd-daemon-user.fchownat32 "$P3" snap_daemon root 2>&1   | MATCH "After: .* uid=$user, gid=0"

    echo "'fchownat - u:root g:snap_daemon' allowed"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" root snap_daemon 2>&1     | MATCH "After: .* uid=0, gid=$group"
    snap run test-snapd-daemon-user.fchownat32 "$P3" root snap_daemon 2>&1   | MATCH "After: .* uid=0, gid=$group"

    echo "'fchownat - u:test g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" test test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" test test 2>&1     | MATCH "Operation not permitted"

    echo "'fchownat - -1 g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" -1 test 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" -1 test 2>&1       | MATCH "Operation not permitted"

    echo "'fchownat - u:test -1' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" test -1 2>&1         | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" test -1 2>&1       | MATCH "Operation not permitted"

    echo "'fchownat - u:test g:root' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" test root 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" test root 2>&1     | MATCH "Operation not permitted"

    echo "'fchownat - u:root g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" root test 2>&1       | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" root test 2>&1     | MATCH "Operation not permitted"

    echo "'fchownat - u:test g:snap_daemon' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" test snap_daemon 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" test snap_daemon 2>&1   | MATCH "Operation not permitted"

    echo "'fchownat - u:snap_daemon g:test' denied"
    chown root:root "$P2" "$P3"
    snap run test-snapd-daemon-user.fchownat "$P2" snap_daemon test 2>&1     | MATCH "Operation not permitted"
    snap run test-snapd-daemon-user.fchownat32 "$P3" snap_daemon test 2>&1   | MATCH "Operation not permitted"
