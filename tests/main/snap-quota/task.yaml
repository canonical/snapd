summary: Basic test for quota-related snap commands.

details: |
  Basic test for snap quota, remove-quota and quotas commands.

# Memory accounting is not functional without workarounds on these old systemd
# systems, so disable the test until we make it functional. The issue is that
# we now will report memory usage information in the daemon response, but due to
# bugs in systemd, this fails without workarounds, and so any quota information
# command will fail trying to get this memory information.
systems:
  - -centos-7-64
  - -amazon-*

prepare: |
  snap install hello-world go-example-webserver test-snapd-tools
  snap set system experimental.quota-groups=true
  tests.cleanup defer snap unset system experimental.quota-groups

execute: |
  if os.query is-trusty; then
    # just check that we can't do anything with quota groups on trusty, systemd
    # there is 204, but we need at least 205 for slice units

    snap set-quota foobar --memory=1MB 2>&1 | MATCH "systemd version too old: snap quotas requires systemd 205 and newer \(currently have 204\)"
    exit 0
  fi

  echo "Creating top-level quota groups (no snaps)"
  snap set-quota group-top1 --memory=400MB
  snap set-quota group-top2 --memory=500MB

  echo "Creating groups with snaps in them"
  snap set-quota group-one --parent=group-top1 --memory=100MB hello-world
  snap set-quota group-two --parent=group-top1 --memory=2MB test-snapd-tools

  echo "Creating some more nested empty quota groups"
  snap set-quota group-sub-one --parent=group-one --memory=500B
  snap set-quota group-sub-sub-one --parent=group-sub-one --memory=500B

  echo "Trying to add snap to more than one group fails"
  snap set-quota group-bad --memory=1MB hello-world 2>&1 | MATCH 'error: cannot create or update quota group: cannot add snap "hello-world" to group "group-bad": snap already in quota group "group-one"'

  echo "Adding a snap to group-one"
  snap set-quota group-one go-example-webserver

  echo "Checking that all quotas can be listed"
  snap quotas | cat -n > quotas.txt
  MATCH "     1\s+Quota\s+Parent\s+Constraints\s+Current$" < quotas.txt
  MATCH "     2\s+group-top1\s+memory=400MB\s+memory=[0-9.a-zA-Z]+$" < quotas.txt
  MATCH "     3\s+group-one\s+group-top1\s+memory=100MB\s+memory=[0-9.a-zA-Z]+$" < quotas.txt
  MATCH "     4\s+group-sub-one\s+group-one\s+memory=500B\s*$" < quotas.txt
  MATCH "     5\s+group-sub-sub-one\s+group-sub-one\s+memory=500B\s*$" < quotas.txt
  MATCH "     6\s+group-two\s+group-top1\s+memory=2.00MB\s*$" < quotas.txt
  MATCH "     7\s+group-top2\s+memory=500MB\s*$" < quotas.txt

  echo "Checking quota group details"
  snap quota group-one | cat -n > details.txt
  MATCH "     1\s+name:\s+group-one$" < details.txt
  MATCH "     2\s+parent:\s+group-top1$" < details.txt
  MATCH "     3\s+constraints:$" < details.txt
  MATCH "     4\s+memory:\s+100MB$" < details.txt
  MATCH "     5\s+current:$" < details.txt
  MATCH "     6\s+memory:\s+[0-9.a-zA-Z]+B$" < details.txt
  MATCH "     7\s+subgroups:$" < details.txt
  MATCH "     8\s+- group-sub-one$" < details.txt
  MATCH "     9\s+snaps:$" < details.txt
  MATCH "    10\s+-\s+hello-world$" < details.txt
  MATCH "    11\s+-\s+go-example-webserver$" < details.txt

  echo "Checking that quota groups can be removed"
  snap remove-quota group-two
  snap quota group-two 2>&1 | MATCH 'error: cannot find quota group "group-two"'
  snap quota unknown 2>&1 | MATCH 'error: cannot find quota group "unknown"'
