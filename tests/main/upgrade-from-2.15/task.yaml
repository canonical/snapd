summary: Ensure upgrades from snapd 2.15 work

systems: [ubuntu-16.04-64]

prepare: |
    dpkg --purge snapd

execute: |
    #shellcheck source=tests/lib/systemd.sh
    . "$TESTSLIB"/systemd.sh

    echo "download snapd 2.15.2ubuntu1 and the matching ubuntu-core-launcher"
    wget https://launchpad.net/ubuntu/+source/snap-confine/1.0.38-0ubuntu0.16.04.8/+build/10606388/+files/ubuntu-core-launcher_1.0.38-0ubuntu0.16.04.8_amd64.deb
    wget https://launchpad.net/ubuntu/+source/snap-confine/1.0.38-0ubuntu0.16.04.8/+build/10606388/+files/snap-confine_1.0.38-0ubuntu0.16.04.8_amd64.deb
    wget https://launchpad.net/ubuntu/+source/snapd/2.15.2ubuntu1/+build/10939171/+files/snapd_2.15.2ubuntu1_amd64.deb
    echo "Install snapd 2.15.2"
    apt install -y ./ubuntu-core-launcher_1.0.38-0ubuntu0.16.04.8_amd64.deb ./snap-confine_1.0.38-0ubuntu0.16.04.8_amd64.deb ./snapd_2.15.2ubuntu1_amd64.deb

    echo "install a service snap and check its active"
    snap install go-example-webserver
    wait_for_service snap.go-example-webserver.webserver.service

    echo "upgrade to current snapd"
    apt install -y "$GOHOME"/snapd*.deb

    echo "and ensure the snap service is still active"
    wait_for_service snap.go-example-webserver.webserver.service
