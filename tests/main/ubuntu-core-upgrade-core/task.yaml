summary: Ensure that a ubuntu-core refresh works

systems: [ubuntu-core-16-64, ubuntu-core-16-arm-64, ubuntu-core-16-arm-32]

execute: |
    . "$TESTSLIB/boot.sh"
    . "$TESTSLIB/names.sh"
    if [ "$SPREAD_REBOOT" = 0 ]; then
        snap list|grep ${core_name}|tr -s " "|cut -f3 -d' ' > firstBoot
        read -r firstBoot < firstBoot
        echo "Ensure we are with the right sideloaded core"
        snap list |grep "${core_name}.*${firstBoot}"
        grep "snap_core=${core_name}_${firstBoot}.snap" /proc/cmdline

        echo "Install a new ${core_name}"
        snap install --dangerous /var/lib/snapd/snaps/${core_name}_${firstBoot}.snap
        snap list|grep ${core_name}|tr -s " "|cut -f3 -d' ' > nextBoot 
        read -r nextBoot < nextBoot
        echo "Ensure we have next installed now"
        snap list |grep "${core_name}.*${nextBoot}"
        if cmp firstBoot nextBoot; then
            echo "Current and next boot version are identical"
            cat firstBoot
            cat nextBoot
            exit 1
        fi

        echo "Ensure the bootloader is correct before reboot"
        test "$(bootenv snap_core)" = "${core_name}_${firstBoot}.snap"
        test "$(bootenv snap_try_core)" = "${core_name}_${nextBoot}.snap"
        test "$(bootenv snap_mode)" = "try"

        echo "Ensure the device is scheduled for auto-reboot"
        output=$(dbus-send --print-reply \
            --type=method_call \
            --system \
            --dest=org.freedesktop.login1 \
            /org/freedesktop/login1 \
            org.freedesktop.DBus.Properties.Get \
            string:org.freedesktop.login1.Manager string:ScheduledShutdown)
        if ! echo $output|grep 'string "reboot"'; then
            echo "Failed to detect scheduled reboot in logind output:"
            echo "$output"
            exit 1
        fi
        REBOOT
    fi

    if [ "$SPREAD_REBOOT" = 1 ]; then
        echo "Waiting for boot-ok to finish"
        while ! systemctl status snapd.boot-ok|grep SUCCESS; do
            echo "Show debug info"
            systemctl status snapd.boot-ok || true
            sleep 1
        done

        echo "Useful debug info"
        bootenv
        cat /proc/cmdline

        read -r nextBoot < nextBoot
        echo "Ensure we booted from the newly installed core snap"
        grep "snap_core=${core_name}_${nextBoot}.snap" /proc/cmdline

        echo "Ensure the bootloader is correct after reboot"
        test "$(bootenv snap_core)" = "${core_name}_${nextBoot}.snap"
        test -z "$(bootenv snap_try_core)"
        test -z "$(bootenv snap_mode)"

        echo "Ensure the snap list contains our new ${core_name} snap"
        snap list |grep "${core_name}.*${nextBoot}"
    fi
