summary: Ensure that the graphical user daemons work as expected

details: |
    This test ensures that an user daemon with the desktop, x11 or wayland plugs
    will be launched with the destkop session only.

# Only classic Ubuntu has the pulseaudio mediation patches. Ubuntu 14.04 is unsupported on the desktop.
# TODO: extend tests.session and run this test on 14.04 as well.
systems: [ubuntu-16.04-*, ubuntu-18.04-*, ubuntu-2*]

prepare: |
    "$TESTSTOOLS"/snaps-state install-local ./test-snapd-implicit-graphical-user-daemon

execute: |
    NORMAL_SERVICE=/etc/systemd/user/snap.test-snapd-daemon-desktop.test-snapd-daemon-user-normal.service
    DESKTOP_SERVICE=/etc/systemd/user/snap.test-snapd-daemon-desktop.test-snapd-daemon-user-in-graphical-desktop.service
    DESKTOP_DBUS_SERVICE1=/etc/systemd/user/snap.test-snapd-daemon-desktop.test-snapd-daemon-user-in-graphical-desktop.service
    DESKTOP_DBUS_SERVICE2=/etc/systemd/user/snap.test-snapd-daemon-desktop.test-snapd-daemon-user-in-graphical-desktop.service

    echo "Ensure graphical daemon has the right dependencies"

    test -f ${NORMAL_SERVICE}
    test -f ${DESKTOP_SERVICE}
    test -f ${DESKTOP_DBUS_SERVICE1}
    test -f ${DESKTOP_DBUS_SERVICE2}

    grep "WantedBy=graphical-session\.target" ${DESKTOP_SERVICE}
    grep "After=graphical-session\.target" ${DESKTOP_SERVICE}
    grep "Requisite=graphical-session\.target" ${DESKTOP_SERVICE}
    grep "BindsTo=graphical-session\.target" ${DESKTOP_SERVICE}

    grep "WantedBy=graphical-session\.target" ${DESKTOP_DBUS_SERVICE1}
    grep "After=graphical-session\.target" ${DESKTOP_DBUS_SERVICE1}
    grep "Requisite=graphical-session\.target" ${DESKTOP_DBUS_SERVICE1}
    grep "PartOf=graphical-session\.target" ${DESKTOP_DBUS_SERVICE1}

    grep "WantedBy=graphical-session\.target" ${DESKTOP_DBUS_SERVICE2}
    grep "After=graphical-session\.target" ${DESKTOP_DBUS_SERVICE2}
    grep "Requisite=graphical-session\.target" ${DESKTOP_DBUS_SERVICE2}
    grep "PartOf=graphical-session\.target" ${DESKTOP_DBUS_SERVICE2}

    grep "WantedBy=default\.target" ${NORMAL_SERVICE}
    jkfi
