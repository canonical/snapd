summary: Ensure that dramatic change in layout does not break updates

details: |
    Recently, the steam snap replaced several bindings with symlinks in the
    layout part, and that resulted in users not being able to update it from
    the "bound" version to the "symlinked" one because snapd complained that
    it couldn't update the mount namespace. The solution consists on discard
    the namespace and retry again.

    The namespace is automatically discarded during snap refresh if no processes
    are running in it (as detected by RAA).

systems:
    # the snaps aren't available for ARM.
    - -ubuntu-*-arm*

prepare: |
    echo "Removing snaps"
    snap remove --purge test-snapd-layout-change || true
    snap remove --purge test-snapd-layout-change-with-daemon || true

restore: |
    echo "Removing snaps"
    snap remove --purge test-snapd-layout-change || true
    snap remove --purge test-snapd-layout-change-with-daemon || true

execute: |
    echo "Testing layout change"

    echo "Installing test snap"
    snap install --beta test-snapd-layout-change
    # the snap has a configure hook, for which a mount ns will be created
    test -e /run/snapd/ns/test-snapd-layout-change.mnt
    # inodes are reused, so combine inode number with modification timestamp
    inode="$(stat -c '%i:%y' /run/snapd/ns/test-snapd-layout-change.mnt)"
    test-snapd-layout-change -c 'true'
    new_inode="$(stat -c '%i:%y' /run/snapd/ns/test-snapd-layout-change.mnt)"
    # mount ns is not discarded when running an app
    test "$inode" = "$new_inode"

    old_inode="$new_inode"

    echo "Refreshing test snap to newer version "
    # mount ns gets discarded and new one is created for the configure hook
    snap refresh --edge test-snapd-layout-change
    test -e /run/snapd/ns/test-snapd-layout-change.mnt
    new_inode="$(stat -c '%i:%y' /run/snapd/ns/test-snapd-layout-change.mnt)"
    test "$new_inode" != "$old_inode"

    echo "Testing layout change with a daemon"

    echo "Installing test snap with daemon"
    snap install --beta test-snapd-layout-change-with-daemon
    test -e /run/snapd/ns/test-snapd-layout-change-with-daemon.mnt
    old_inode="$(stat -c '%i:%y' /run/snapd/ns/test-snapd-layout-change-with-daemon.mnt)"

    echo "Refreshing test snap with daemon to newer version"
    # daemon is of type 'simple' and it gets restarted during the refresh
    if snap refresh --edge test-snapd-layout-change-with-daemon > err.log 2>&1 ; then
        echo "ERROR: running snap refresh for test-snapd-layout-change-with-daemon did not fail as expected"
        exit 1
    fi
    MATCH 'cannot update snap namespace: cannot create symlink .* existing file in the way' < err.log
    # mount ns not discarded across refresh as the snap has a daemon service
    # with 'endure' refresh mode
    new_inode="$(stat -c '%i:%y' /run/snapd/ns/test-snapd-layout-change-with-daemon.mnt)"
    # same captured namespace file
    test "$new_inode" == "$old_inode"
