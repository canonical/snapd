summary: Check that `snap auto-import` works as expected

systems: [ubuntu-core-16-64]

prepare: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi
    echo "Ensure the testrootorg-store.account-key is not already added"
    output=$(snap known account-key | grep "name: test-store"|wc -l)
    if [ "$output" != "0" ]; then
            echo " testrootorg-store.account-key is already added"
            exit 1
    fi
    echo "Create a ramdisk with the testrootorg-store.account-key assertion"
    mkfs.vfat /dev/ram0
    mount /dev/ram0 /mnt
    cp $TESTSLIB/assertions/testrootorg-store.account-key /mnt/auto-import.assert

    # there's currently a system user created on first boot, we'll remove the state that denotes this
    cp /var/lib/snapd/state.json ./state.json.back
    sed -i 's/"users":\[[^]]*\]/"users":null/' /var/lib/snapd/state.json

restore: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi
    umount /mnt
    mv ./state.json.back /var/lib/snapd/state.json

execute: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi
    echo "`snap auto-import` imports assertions from the mounted ramdisk"
    snap auto-import
    snap known account-key | grep "name: test-store"
