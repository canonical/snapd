summary: Ensure that the gpio physical memory control interface works.

details: |
    The gpio-memory-control interface allows read/write access to all gpio memory.

environment:
    CONNECTED_PATTERN: ':gpio-memory-control +test-snapd-gpio-memory-control'
    DISCONNECTED_PATTERN: '\- +test-snapd-gpio-memory-control:gpio-memory-control'

prepare: |
    . $TESTSLIB/snaps.sh

    echo "Given the test-snapd-gpio-memory-control snap is installed"
    install_local test-snapd-gpio-memory-control

restore: |
    rm -f call.error

execute: |
    if ! [ -c /dev/gpiomem ]; then
        echo "The /dev/gpiomem device does not exist in current system"
        exit 0
    fi

    echo "The interface is not connected by default"
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "When the interface is connected"
    snap connect test-snapd-gpio-memory-control:gpio-memory-control
    snap interfaces | MATCH "$CONNECTED_PATTERN"

    echo "Then the snap is able access to the physical memory"
    test-snapd-gpio-memory-control.sh -c "dd if=/dev/gpiomem of=/dev/null bs=1024 count=1"

    if [ "$(snap debug confinement)" = partial ] ; then
        exit 0
    fi

    echo "When the plug is disconnected"
    snap disconnect test-snapd-gpio-memory-control:gpio-memory-control
    snap interfaces | MATCH "$DISCONNECTED_PATTERN"

    echo "Then the snap is not able to access the gpio physical memory"
    if test-snapd-gpio-memory-control.sh -c "dd if=/dev/gpiomem of=/dev/null bs=1024 count=1" 2>${PWD}/call.error; then
        echo "Expected permission error accessing to gpio physical memory with disconnected plug"
        exit 1
    fi
    MATCH "Permission denied" < call.error
