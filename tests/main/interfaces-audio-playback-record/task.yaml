summary: Ensure that the audio-playback/record interface works

# Classic Ubuntu is sufficient to test the feature
systems: [ ubuntu-1*-*64 ]

environment:
    PLAY_FILE: "/snap/test-snapd-audio-record/current/usr/share/sounds/alsa/Noise.wav"
    # today, only 19.04 and 19.10 have a mediating pulseaudio
    EXFAIL: "ubuntu-14 ubuntu-16 ubuntu-18"

prepare: |
    #shellcheck source=tests/lib/pkgdb.sh
    . "$TESTSLIB"/pkgdb.sh
    snap install --edge test-snapd-audio-record

    apt-get update
    apt-get install -y pulseaudio

    echo "Create XDG_RUNTIME_DIR=/run/user/12345"
    # shellcheck disable=SC2174
    mkdir -m 700 -p /run/user/12345 || true
    chown test:test /run/user/12345

restore: |
    HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 su -p -c "pulseaudio --kill" test || true
    snap remove test-snapd-audio-record
    apt autoremove --purge -y pulseaudio

execute: |
    # we need -p so that XDG_RUNTIME_DIR is honored, but that preserves HOME,
    # so specify it too since pulseaudio fails to start otherwise
    echo "Start pulseaudio"
    HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 su -p -c "pulseaudio --exit-idle-time=30" test &

    echo "Then wait for the socket to show up"
    count=0
    while sleep 1 && [ ! -S /run/user/12345/pulse/native ]; do
        echo $count
        count=$((count+1))
        if [ "$count" -gt 10 ]; then
            echo "Could not find pulseaudio socket"
            exit 1
        fi
    done

    echo "Check pulseaudio"
    count=0
    while sleep 1 && ! HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 su -p -c "pulseaudio --check" test ; do
        echo $count
        count=$((count+1))
        if [ "$count" -gt 10 ]; then
            echo "'pulseaudio --check' only returned with error"
            exit 1
        fi
    done

    echo "The audio-playback interface is connected by default"
    snap interfaces -i audio-playback | MATCH ":audio-playback .*test-snapd-audio-record"

    echo "The audio-record interface is disconnected by default"
    snap interfaces -i audio-record | MATCH "\- +test-snapd-audio-record:audio-record"

    echo "When the audio-playback plug is connected"
    snap connect test-snapd-audio-record:audio-playback

    echo "Then the snap can play audio"
    su -l -c "test-snapd-audio-record.play $PLAY_FILE" test

    echo "When the audio-record plug is connected"
    snap connect test-snapd-audio-record:audio-record

    echo "Then the snap can record audio"
    su -l -c "test-snapd-audio-record.recsimple" test

    echo "When the audio-record plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-record

    ok_to_fail="no"
    for regex in $EXFAIL ; do
        if echo "$SPREAD_SYSTEM" | grep -Eq "$regex" ; then
            ok_to_fail="yes"
            break
        fi
    done

    echo "Then the snap command is not able to record audio"
    if ! su -l -c "test-snapd-audio-record.record" test ; then
        if [ "$ok_to_fail" = "yes" ]; then
            echo "Could not record audio. '$SPREAD_SYSTEM' now has support. Please update this test"
            exit 1
        fi
    elif [ "$ok_to_fail" = "no" ]; then
        echo "could record audio!"
        exit 1
    fi

    if [ "$(snap debug confinement)" = "partial" ] ; then
        exit 0
    fi

    echo "When the audio-playback plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-playback

    echo "Then the snap command is not able to connect to the pulseaudio socket"
    if su -l -c "test-snapd-audio-record.play $PLAY_FILE" test ; then
        echo "Expected error with plug disconnected"
        exit 1
    fi
