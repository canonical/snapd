summary: Ensure that the audio-playback/record interface works

# Only classic Ubuntu has the pulseaudio mediation patches. Ubuntu 14.04 is unsupported on the desktop.
# TODO: extend session-tool and run this test on 14.04 as well.
systems: [ubuntu-16.04-*, ubuntu-18.04-*, ubuntu-19.10-*, ubuntu-20.04-*]

environment:
    PLAY_FILE: "/snap/test-snapd-audio-record/current/usr/share/sounds/alsa/Noise.wav"
    # today, 16.04 and higher have a mediating pulseaudio
    EXFAIL: "ubuntu-14"

prepare: |
    truncate --size=0 defer.sh
    chmod +x defer.sh

    # Install pulseaudio.
    apt-get update
    apt-get install -y pulseaudio pulseaudio-utils
    echo "apt-get autoremove --purge -y pulseaudio pulseaudio-utils" >>defer.sh

    # Make sure the socket and the server is available in the user session.
    if [ "$(systemctl --user --global is-enabled pulseaudio.socket)" != enabled ]; then
        systemctl --user --global enable pulseaudio.socket
        echo "systemctl --user --global disable pulseaudio.socket" >>defer.sh
    fi
    if [ "$(systemctl --user --global is-enabled pulseaudio.service)" != enabled ]; then
        systemctl --user --global enable pulseaudio.service
        echo "systemctl --user --global disable pulseaudio.service" >>defer.sh
    fi

    # Install a snap that uses the audio-playback/audio-record interfaces.
    snap install --edge test-snapd-audio-record
    echo "snap remove --purge test-snapd-audio-record" >>defer.sh

    # Prepare a session for the user.
    session-tool -u test --prepare
    echo "session-tool -u test --restore" >>defer.sh

restore: |
    # Restore system to the previous state by running deferred commands in
    # reverse order.
    tac defer.sh > refed.sh
    sh -xe refed.sh && rm -f {defer,refed}.sh

execute: |
    echo "ensure that we have a pulse socket"
    retry-tool test -S /run/user/12345/pulse/native

    echo "Check that the daemon is running"
    retry-tool session-tool -u test pulseaudio --check

    echo "The unconfined user can play audio"
    session-tool -u test /usr/bin/paplay "$PLAY_FILE"

    echo "The unconfined user can record audio"
    session-tool -u test /snap/test-snapd-audio-record/current/bin/parec-simple

    echo "The audio-playback interface is connected by default"
    snap connections test-snapd-audio-record | MATCH "audio-playback +test-snapd-audio-record:audio-playback +:audio-playback +-"

    echo "The audio-record interface is disconnected by default"
    snap connections test-snapd-audio-record | MATCH "audio-record +test-snapd-audio-record:audio-record +- +-"

    echo "When the audio-playback plug is connected"
    snap connect test-snapd-audio-record:audio-playback

    echo "Then the snap can play audio"
    session-tool -u test test-snapd-audio-record.play "$PLAY_FILE"

    echo "When the audio-record plug is connected"
    snap connect test-snapd-audio-record:audio-record

    echo "Then the snap can record audio"
    session-tool -u test test-snapd-audio-record.recsimple

    echo "When the audio-record plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-record

    mediating_pa="yes"
    if echo "$SPREAD_SYSTEM" | grep -Eq "$EXFAIL" ; then
        mediating_pa="no"
    fi

    echo "Then the snap command is not able to record audio"
    if [ "$mediating_pa" = "no" ] && ! session-tool -u test test-snapd-audio-record.recsimple; then
        echo "Could not record audio. Does '$SPREAD_SYSTEM' have mediation patches?"
        exit 1
    elif [ "$mediating_pa" = "yes" ] && session-tool -u test test-snapd-audio-record.recsimple; then
        echo "Could record audio even though '$SPREAD_SYSTEM' should have mediation patches"
        exit 1
    fi

    if [ "$(snap debug confinement)" = "partial" ] ; then
        exit 0
    fi

    echo "When the audio-playback plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-playback

    echo "Then the snap command is not able to connect to the pulseaudio socket"
    if session-tool -u test test-snapd-audio-record.play "$PLAY_FILE"; then
        echo "Expected error with plug disconnected"
        exit 1
    fi
