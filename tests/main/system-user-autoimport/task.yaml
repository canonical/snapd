summary: Check that the system-user assertion autoimport works on cold-plug

backends: [qemu]

systems: [ubuntu-16.04-64]

details: |
    The test uses a nested ubuntu-core image to check that the system-user
    assertion is properly imported. We sign the model and system-user assertion
    with the same key, so that the system-user assertion can be validated.

environment:
    SSH_PORT: 8022
    USER: user1
    PASSWORD: ubuntu
    UNPACKD: /tmp/core-snap
    IMAGE_HOME: /home/image

prepare: |
    apt install -y qemu genisoimage sshpass

    # model and system-user assertions (signed by the same key)
    cat > pc.model <<EOF
    type: model
    authority-id: ezPmSahqWjPQWhv3o4cY0MG0JkqpKIoL
    series: 16
    brand-id: ezPmSahqWjPQWhv3o4cY0MG0JkqpKIoL
    model: pc
    architecture: amd64
    gadget: pc
    kernel: pc-kernel
    timestamp: 2016-09-16T15:03:21+00:00
    sign-key-sha3-384: uv2i3nctwgiMQQ2rd_9mhwHsQbTRJPHnpeQjpRbSfs4m3lxhH2E89wkKKqYp_8i5

    AcLBXAQAAQoABgUCV+JS/QAKCRCi4irWmF+hRWiBD/43ZWNoYff2lQXdmqAHGmfnCp13GqaSNBvf
    rfOYw7rOoQK1FeAdijfzLfoBEaP+CfPB7WdenTQGRxwX2z1p8sSxPyD9eXjw/spzdhIh6/8lp8yC
    4Dq3G9r9ySbokExwsV4XQnly9dWPzZP+DejxyroUFERsj3drEEI94b7aN/fUEYeqU1QEIOi+VCmT
    t9iGV+fUYuk7UBIOOVqLmSKgqOw3NsmSjLbASsl4SsyQ3eMQoNs8hzCmp2N/IrwMXPoUu7Ivi/zZ
    bOIiCGC1YPrWJzUZ4C/B89EiilOPHnk98Umr76tIM7X0EnS8cYnyuLx9hDczLC5a2uE0PC45rmZB
    abjkTVea6i735RrE6Ffw/aWLMfp32vL7JOnOqkyzp/2g0IyYAyY3wvVea2IyWhI2wz532Es71gEa
    MAu8jiWn3rncvQNf0j2eCzhg0ZJ7G0+Qe19D7heLCP+/tpt+kOYDT0o8+drezRMuIiU5JE4/sxan
    YVRjpYzQPuNx13elAzJXy+24wnKMOwUuHCm25TMUPI1j/3Fw2xPqqYnkhkR6OaBF0ZuAxRYMUsWw
    gKWGS2nim2+DVh2d4NbAQtYDVRqAm/jCY0180aZ9/G2iqk66pMGDW9Njy9Rl+YgXyyqn6PYpSt6r
    v0ZF1XkDWGLaB2ohNugO6j8fp0MiKWs3WPWdnsXVIw==
    EOF
    cat > auto-import.assert <<"EOF"
    type: system-user
    authority-id: ezPmSahqWjPQWhv3o4cY0MG0JkqpKIoL
    revision: 1
    brand-id: ezPmSahqWjPQWhv3o4cY0MG0JkqpKIoL
    email: snappy-dev@lists.launchpad.net
    models:
      - pc
      - pi2
      - pi3
      - dragonboard
    name: user1
    password: $6$o5er943Y$cngsJHutSgACVbR65WAnhaUPC9.vENj8locb50hvMdMRMK8cQ3Zbu6WPh5Al2JrnHzpR63osPCwE/IFG/2s6K1
    series:
      - 16
    since: 2016-10-10T15:03:21+00:00
    until: 2017-10-09T15:03:21+00:00
    username: user1
    sign-key-sha3-384: uv2i3nctwgiMQQ2rd_9mhwHsQbTRJPHnpeQjpRbSfs4m3lxhH2E89wkKKqYp_8i5

    AcLBXAQAAQoABgUCWA96EQAKCRCi4irWmF+hRS1MEACI9PPbuHOn3ydXZH4W4Hd/QiFsAGAN+rDK
    zyhTuLxt0axGAXERIElibhiCzpzTrIg7g5/pUEmVELpJYQzvg1oSEGllrK85ODTDjgZr/jW2jITm
    XN0mN3GOSimTvvQiAXF/pKGOBBAwHUojLt9FPM4WWPnwUq4wnkPVvTExgNrX5FOYtYvPG6YEejbK
    B6AKcs0d66z72n+0R3JON35Cis7EhUap7myYZMulT5Qhox785XidNFS0qbmpOGX1llBNjmY8JlqS
    DkktXryyU4lzNfCe8q1x2H84XZlD+bCRBlfSBA1+9aipLHl6PcaqeGyItmiX9+/xCtkQs96mYiNf
    vxBDhw7BL6xS00lNt/RQwkHOVGcNhZTxhw5apYkMaCRjoRr0QKssRwLJMp67l2Obl57tkFbxRFZ+
    Pi/zFWmxU3A0ns1N51D7ywaF4d6hRPs3kZNukz6pnwGOSRPNbEhwVwUHEvTTGxT3rvTPMe/63nFZ
    heah8N+zToHS+ljzOfQc6hP01bjanz+lgYz+ZdJl3tletuCTjzhSp4voOBYemZMeVYz69SWlrPel
    X1Ktv+zHg9xBfiXHUFKfcAJ8sQfrJqjjaNzmrx27s6o6l1x1mNd6ml3cPWo6ctecAZvSuQJSwwFq
    EZTyBuW2tUoGqNuqlMDZdszMnIGlC6/UGvmEHp2GVw==
    EOF

    # modify the core snap so that it includes the new snapd
    unsquashfs -d $UNPACKD /var/lib/snapd/snaps/core_*.snap
    dpkg-deb -x ${SPREAD_PATH}/../snapd_*.deb $UNPACKD

    # allow ssh root access for inspection
    want_pw="$(grep ^ubuntu /etc/shadow)"
    echo "$want_pw" > /tmp/new-shadow
    sed -i 's/^ubuntu/root/' /tmp/new-shadow
    tail -n +2 /etc/shadow >> /tmp/new-shadow
    cp -v /tmp/new-shadow $UNPACKD/etc/shadow
    cp -v /etc/passwd $UNPACKD/etc/passwd
    sed -i 's/\(PermitRootLogin\|PasswordAuthentication\)\>.*/\1 yes/' $UNPACKD/etc/ssh/sshd_config

    # build new core snap for the image
    mkdir -p $IMAGE_HOME
    snapbuild $UNPACKD $IMAGE_HOME

    # create ubuntu-core image
    snap install --devmode --edge ubuntu-image
    /snap/bin/ubuntu-image ./pc.model --channel edge --extra-snaps $IMAGE_HOME/core_*.snap --output ubuntu-core.img

    # create assertion block device
    genisoimage -volid cidata -joliet -rock -o assertions.disk auto-import.assert

restore: |
    . $TESTSLIB/systemd.sh
    systemd_stop_and_destroy_unit nested-vm
    rm -f ubuntu-core.img assertions.disk pc.model auto-import.assertion /tmp/new-shadow
    rm -rf $UNPACKD $IMAGE_HOME
    apt remove -y qemu genisoimage sshpass

execute: |
    execute_remote_command(){
        sshpass -p $PASSWORD ssh -p $SSH_PORT -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER@localhost "$*"
    }

    wait_for_ssh(){
        retry=30
        while ! execute_remote_command true; do
            retry=$(( retry - 1 ))
            if [ $retry -le 0 ]; then
                echo "Timed out waiting for ssh. Aborting!"
                exit 1
            fi
            sleep 10
        done
    }

    . $TESTSLIB/systemd.sh
    systemd_create_and_start_unit nested-vm "$(which qemu-system-$(uname -m)) -m 512 -nographic -snapshot -net nic,model=virtio -net user,hostfwd=tcp::"$SSH_PORT"-:22 ${PWD}/ubuntu-core.img -drive file=${PWD}/assertions.disk,if=ide"

    wait_for_ssh

    execute_remote_command echo hello
