summary: Ensure that the shared-memory interface's private mode works.

details: |
    The shared-memory interface has a "private" attribute.
    The shared-memory interface allows two snaps to share a POSIX shared memory
    object declared in the slot of the provider snap.

prepare: |
    "$TESTSTOOLS"/snaps-state install-local shm-private
    tests.session -u test prepare

restore: |
    tests.session -u test restore
    snap remove --purge shm-private
    rm -rf /dev/shm/snap.shm-private

execute: |
    echo "shared-memory plugs with 'private: true' set are autoconnected"
    snap connections shm-private | MATCH "shared-memory +shm-private:shmem-private +:shared-memory +-"

    echo "The snap can create arbitrary named segments under /dev/shm"
    shm-private.cmd touch /dev/shm/root-segment
    tests.session -u test exec shm-private.cmd touch /dev/shm/user-segment

    echo "The shm segments are not visible to the host system"
    not test -f /dev/shm/root-segment
    not test -f /dev/shm/user-segment

    echo "But are visible to the snap"
    shm-private.cmd test -f /dev/shm/root-segment
    shm-private.cmd test -f /dev/shm/user-segment

    echo "The private shm segments are stored in a subdirectory of /dev/shm"
    test -f /dev/shm/snap.shm-private/root-segment
    test -f /dev/shm/snap.shm-private/user-segment
