summary: Basic hotplug tests

prepare: |
    # shellcheck source=tests/lib/systems.sh
    . "$TESTSLIB/systems.sh"
    if is_classic_system; then
        snap install core
    fi

execute: |
    echo "Enable hotplug"
    snap set core experimental.hotplug=true

    # load dummy network device module
    modprobe dummy

    # hotplug event may take a few moments to be processed
    for i in $(seq 5); do
        if snap interfaces | MATCH "net-dummy-"; then
            break
        fi
        sleep 1
    done
    snap interfaces | MATCH "net-dummy-dummy0"

    #shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB"/snaps.sh
    install_local snap-hotplug-dummy

    snap connect snap-hotplug-dummy:dummy :net-dummy-dummy0
