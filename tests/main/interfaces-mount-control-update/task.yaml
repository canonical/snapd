summary: Test for the mount-control interface

systems:
    - -ubuntu-14.04-*  # buggy systemd mount unit support

environment:
    MOUNT_SRC: /var/tmp/test-snapd-mount-control
    SNAP_COMMON: /var/snap/test-snapd-mount-control/common

prepare: |
    mkdir -p "$MOUNT_SRC/dir1"
    echo "Something" > "$MOUNT_SRC/file1"

restore: |
    rm -rf "$MOUNT_SRC"

execute: |
    SNAP_NAME="test-snapd-mount-control"
    MOUNT_DEST="$SNAP_COMMON/target"

    # first pass: install the snap and try basic mount operations
    echo "Installing the test snap"

    "$TESTSTOOLS"/snaps-state install-local v1

    echo "Connecting the mount-control interface"
    snap connect "${SNAP_NAME}":mntctl

    echo "Verify that the snap can perform a mount"
    mkdir -p "$MOUNT_DEST"
    "${SNAP_NAME}".cmd snapctl mount -o bind,rw "$MOUNT_SRC" "$MOUNT_DEST"

    echo "Verify that the mount has been performed"
    "${SNAP_NAME}".cmd grep "$MOUNT_DEST" /proc/self/mountinfo

    echo "Ensure that the mounted files are visible"
    "${SNAP_NAME}".cmd test -e "$MOUNT_DEST/file1"

    echo "Update the snap to a new version"
    "$TESTSTOOLS"/snaps-state install-local v2

    echo "Verify that the mount is still in place"
    "${SNAP_NAME}".cmd grep "$MOUNT_DEST" /proc/self/mountinfo
    "${SNAP_NAME}".cmd test -e "$MOUNT_DEST/file1"
    systemctl show -p Where '*.mount' | MATCH "$MOUNT_DEST"

    echo "Unmount"
    "${SNAP_NAME}".cmd snapctl umount "$MOUNT_DEST"
    "${SNAP_NAME}".cmd grep "$MOUNT_DEST" /proc/self/mountinfo && exit 1
    "${SNAP_NAME}".cmd test "!" -e "$MOUNT_DEST/file1"
    if systemctl show -p Where '*.mount' | MATCH "$MOUNT_DEST"; then
        echo "Error: mount unit not removed"
        exit 1
    fi
