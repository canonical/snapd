summary: Check that 'snapctl refresh' works with the tracking flag

details: |
    Verifies the snapctl refresh command works as expected when using the --tracking flag.
    The test checks that other snapctl refresh commands still require root privileges, and
    tests how snapctl refresh behaves with different channels set.

environment:
    USER/root: root
    USER/user0: user0

prepare: |
    "$TESTSTOOLS"/snaps-state install-local test-snapd-sh-core24

restore: |
    snap remove --purge test-snapd-sh-core24

execute: |
    snapd_release=$(test-snapd-sh-core24.sh -c 'snapctl refresh --tracking')
    echo "$snapd_release" | gojq --yaml-input -r .channel | MATCH "null"

    snap switch test-snapd-sh-core24 --channel latest/stable
    snapd_release=$(test-snapd-sh-core24.sh -c 'snapctl refresh --tracking')
    echo "$snapd_release" | gojq --yaml-input -r .channel | MATCH "latest/stable"

    if [ "$USER" != "root" ]; then
        not tests.session exec test sh -c "test-snapd-sh-core24.sh -c 'snapctl refresh --pending'" > user-err-pending.log 2>&1
        MATCH "^non-root users can only use --tracking with the refresh command$" < user-err-pending.log
    fi