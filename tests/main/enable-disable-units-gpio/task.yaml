summary: Check that systemd units are enabled/disabled and gpio works after rebooting

systems: [ubuntu-core-16-64]

environment:
    GPIO_MOCK_DIR: /tmp/gpio-mock

prepare: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi
    # install snap declaring a plug on the gpio slot
    . $TESTSLIB/snaps.sh
    install_local gpio-consumer

    # prepare gpio mock device
    mkdir -p $GPIO_MOCK_DIR
    touch $GPIO_MOCK_DIR/gpio100
    mount --bind $GPIO_MOCK_DIR /sys/class/gpio

restore: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi
    umount /sys/class/gpio || true
    rm -rf $GPIO_MOCK_DIR

execute: |
    if [ "$TRUST_TEST_KEYS" = "false" ]; then
        echo "This test needs test keys to be trusted"
        exit
    fi

    if [ "$SPREAD_REBOOT" = "0" ]; then
        . "$TESTSLIB/names.sh"
        snap connect gpio-consumer:gpio ${core_name}:gpio-pin
    fi

    # check that the gpio unit service was run
    expected="Unit snap.core.interface.gpio-100.service has finished starting up"
    journalctl -xe --no-pager | grep "$expected"

    if [ "$SPREAD_REBOOT" = "0" ]; then
        REBOOT
    fi
