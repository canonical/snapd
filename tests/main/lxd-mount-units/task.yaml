summary: Test mount units generated for snaps inside lxd container are correct.

details: |
    Test that mount units generated by snapd-generator inside lxd container
    are correct for snapfuse.

# only 20.04+, we want lxd images that come with snaps preinstalled.
systems: [ubuntu-20*, ubuntu-21.04*, ubuntu-21.10*]

restore: |
    lxd.lxc stop ubuntu --force || true
    lxd.lxc delete ubuntu || true
    snap remove --purge lxd

execute: |
    echo "Install lxd"
    snap install lxd

    lxd waitready
    lxd init --auto

    # Define the core snap for the current system
    core_snap=core20

    echo "Setting up proxy for lxc"
    if [ -n "${http_proxy:-}" ]; then
        lxd.lxc config set core.proxy_http "$http_proxy"
    fi
    if [ -n "${https_proxy:-}" ]; then
        lxd.lxc config set core.proxy_https "$http_proxy"
    fi

    VERSION_ID="$(. /etc/os-release && echo "$VERSION_ID" )"
    lxd.lxc launch --quiet "ubuntu:$VERSION_ID" ubuntu

    echo "Setting up proxy *inside* the container"
    if [ -n "${http_proxy:-}" ]; then
        lxd.lxc exec ubuntu -- sh -c "echo http_proxy=$http_proxy >> /etc/environment"
    fi
    if [ -n "${https_proxy:-}" ]; then
        lxd.lxc exec ubuntu -- sh -c "echo https_proxy=$https_proxy >> /etc/environment"
    fi
    # wait for the container to be fully up
    retry -n 30 sh -c 'lxd.lxc exec ubuntu -- systemctl is-system-running | MATCH "(running|degraded)"'

    lxd.lxc file push --quiet "$GOHOME"/snapd_*.deb "ubuntu/root/"

    DEB=$(basename "$GOHOME"/snapd_*.deb)
    lxd.lxc exec ubuntu -- apt update
    lxd.lxc exec ubuntu -- apt install -y /root/"$DEB"
    lxd.lxc restart ubuntu

    echo "Sanity check that mount overrides were generated inside the container"
    lxd.lxc exec ubuntu -- find /var/run/systemd/generator/ -name container.conf | MATCH "/var/run/systemd/generator/snap-${core_snap}.*mount.d/container.conf"
    lxd.lxc exec ubuntu -- test -f /var/run/systemd/generator/snap.mount

    echo "Sanity check that $core_snap snap is mounted correctly"
    # Make sure $core_snap is mounted and readable for a regular user
    retry -n 5 --wait 1 sh -c "lxd.lxc exec ubuntu -- sudo --user ubuntu --login ls /snap/${core_snap}/current"
    retry -n 5 --wait 1 sh -c "lxd.lxc exec ubuntu -- sudo --user ubuntu --login mount | grep $core_snap | grep allow_other"

    echo "Check that snapfuse mount options of generated units match those generated by snapd"
    # the only way to get mount options used by snapd is to install a new snap
    retry -n 5 --wait 1 sh -c 'lxd.lxc exec ubuntu snap install hello-world'
    REFERENCE_MOUNT_OPTS=$(lxd.lxc exec ubuntu -- find /etc/systemd/system -maxdepth 1 -name 'snap-hello*' -exec cat {} \; | grep Options)
    MOUNT_OPTS=$(lxd.lxc exec ubuntu -- find /var/run/systemd/generator -name 'container.conf' -exec cat {} \; | grep Options | tail -n1)
    if [ "$REFERENCE_MOUNT_OPTS" != "$MOUNT_OPTS" ]; then
        echo "Mount options for snapfuse written by snapd are different than those written by snapd-generator:"
        echo "Expected: $REFERENCE_MOUNT_OPTS"
        echo "Actual: $MOUNT_OPTS"
        exit 1
    fi
