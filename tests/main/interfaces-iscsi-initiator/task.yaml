summary: Ensure that the iscsi-initiator interface works.

details: |
  The iscsi-initiator interface allows snaps to act as iSCSI initiators,
  enabling them to discover, connect to, and manage iSCSI targets for
  block storage access.

  A snap which defines an iscsi-initiator plug must be shown in the interfaces
  list. The plug must not be auto-connected on install and, as usual, must be
  able to be reconnected.

  A snap declaring a plug on this interface must be able to access iSCSI
  configuration files, ConfigFS for Linux-IO (LIO) target management,
  and communicate with the iSCSI daemon.

# Disable tests for core environments, needs to install additional packages
# Disable tests for ubuntu 1* environments, as they are not a target of this change
# and `--collect` argument to systemd-run is not supported there.
# Disable tests for opensuse-15* environments
systems: [-ubuntu-core-*, -ubuntu-1*, -opensuse-15*]

environment:
  TEST_SNAP: test-iscsi-initiator-interfaces

prepare: |
  echo "Create test iSCSI configuration directory structure"
  "$TESTSTOOLS"/fs-state mock-dir /etc/iscsi/nodes
  tests.cleanup defer "$TESTSTOOLS"/fs-state restore-dir /etc/iscsi/nodes
  "$TESTSTOOLS"/fs-state mock-file /etc/iscsi/initiatorname.iscsi
  tests.cleanup defer "$TESTSTOOLS"/fs-state restore-file /etc/iscsi/initiatorname.iscsi
  "$TESTSTOOLS"/fs-state mock-file /etc/iscsi/iscsid.conf
  tests.cleanup defer "$TESTSTOOLS"/fs-state restore-file /etc/iscsi/iscsid.conf
  echo "InitiatorName=iqn.1993-08.org.debian:01:abcdef123" > /etc/iscsi/initiatorname.iscsi
  echo "node.startup = automatic" > /etc/iscsi/iscsid.conf

  snap install "$TEST_SNAP" --channel=latest/edge

  # Stop iscsid socket if running to avoid interference with the test
  if systemctl is-active --quiet iscsid.socket; then
      systemctl stop iscsid.socket
      tests.cleanup defer systemctl start iscsid.socket
  fi

  tests.pkgs install socat
  systemd-run --unit socat-for-test.service --collect -- socat abstract-listen:ISCSIADM_ABSTRACT_NAMESPACE,fork -
  tests.cleanup defer systemctl stop socat-for-test.service

execute: |
  echo "The interface is not connected by default"
  snap interfaces -i iscsi-initiator | MATCH -- '- +'"$TEST_SNAP"':iscsi-initiator'

  echo "When the interface is connected"
  snap connect "$TEST_SNAP":iscsi-initiator

  echo "Then the snap is able to access iSCSI configuration files"
  "$TEST_SNAP".client -c "cat /etc/iscsi/initiatorname.iscsi"
  "$TEST_SNAP".client -c "cat /etc/iscsi/iscsid.conf"

  echo "And the snap is able to access iSCSI nodes directory"
  "$TEST_SNAP".client -c "ls /etc/iscsi/nodes"

  echo "And the snap is able to access iSCSI runtime directories"
  "$TEST_SNAP".client -c "mkdir -p /run/lock/iscsi"
  "$TEST_SNAP".client -c "ls /run/lock/iscsi"

  echo "And the snap is able to access iSCSI transport information"
  "$TEST_SNAP".client -c "ls /sys/devices/virtual/iscsi_transport/tcp"

  echo "And the snap is able to communicate with the iSCSI abstract socket"
  if ! "$TEST_SNAP".client -c "echo test | socat -v - abstract-connect:ISCSIADM_ABSTRACT_NAMESPACE"; then
      echo "Expected to be able to communicate with the iSCSI abstract socket"
      exit 1
  fi

  if [ "$(snap debug confinement)" = partial ] ; then
      exit 0
  fi

  echo "When the plug is disconnected"
  snap disconnect "$TEST_SNAP":iscsi-initiator

  echo "Then the snap is not able to access iSCSI configuration files"
  if "$TEST_SNAP".client -c "cat /etc/iscsi/initiatorname.iscsi"; then
      echo "Expected permission error accessing iSCSI configuration with disconnected plug"
      exit 1
  fi

  echo "And the snap is not able to communicate with the iSCSI abstract socket"
  if "$TEST_SNAP".client -c "echo test | socat -v - abstract-connect:ISCSIADM_ABSTRACT_NAMESPACE"; then
      echo "Expected not to be able to communicate with the iSCSI abstract socket"
      exit 1
  fi

  echo "Then the interface can be connected again"
  snap connect "$TEST_SNAP":iscsi-initiator
