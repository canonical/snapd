summary: Ensure snap userd allows opening a URL via xdg-open

systems:
    # Not supposed to work on Ubuntu Core systems as we don't have
    # a user session environment there
    - -ubuntu-core-*

restore: |
    systemctl stop --signal=KILL test-dbus-session.scope || true
    systemctl stop --signal=KILL test-snap-userd.scope || true
    umount -f /usr/bin/xdg-open || true
    umount -f /snap/core/current/usr/bin/xdg-open || true


execute: |
    . "$TESTSLIB/pkgdb.sh"
    . "$TESTSLIB/dirs.sh"

    # Install necessary pacakges to get dbus-launch helper
    distro_install_package dbus-x11 xdg-utils

    # Run a dbus session bus and the snap userd service via systemd
    # to allow easier tracking of any started processes.
    export DBUS_SESSION_BUS_ADDRESS=unix:abstract=/tmp/dbus-test-snap-user
    systemd-run \
        --scope \
        --unit=test-dbus-session \
        --no-block \
        /usr/bin/dbus-daemon --address="$DBUS_SESSION_BUS_ADDRESS" --fork --session

    systemd-run \
        --scope \
        --unit=test-snap-userd \
        --no-block \
        --setenv=DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
        /bin/sh -c '/usr/bin/snap userd &'

    # Wait until the service is up and running
    while ! systemctl is-active test-snap-userd.scope ; do
        sleep .1
    done

    # Create a small helper which will tell us if snap passes
    # the URL correctly to the right handler
    cat << 'EOF' > /tmp/xdg-open
    #!/bin/sh
    echo "$@" > /tmp/xdg-open-output
    EOF
    chmod +x /tmp/xdg-open
    mount --bind /tmp/xdg-open /usr/bin/xdg-open

    # Until necessary changes landed in the core snap we need
    # to create a custom one which points to the new service
    # name io.snapcraft.SafeLauncher where the current core
    # snap still uses com.canonical.SafeLauncher.
    cat << 'EOF' > /tmp/xdg-open-core
    #!/bin/sh
    dbus-send --print-reply --session --dest=io.snapcraft.SafeLauncher / io.snapcraft.SafeLauncher.OpenURL string:"$1"
    EOF
    chmod +x /tmp/xdg-open-core
    mount --bind /tmp/xdg-open-core /snap/core/current/usr/bin/xdg-open

    ensure_xdg_open_output() {
        rm -f /tmp/xdg-open-output
        DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS \
            /snap/core/current/usr/bin/xdg-open $1
        test -e /tmp/xdg-open-output
        test "$(cat /tmp/xdg-open-output)" = $1
    }

    # Ensure http, https and mailto work
    ensure_xdg_open_output "https://snapcraft.io"
    ensure_xdg_open_output "http://snapcraft.io"
    ensure_xdg_open_output "mailto:talk@snapcraft.io"

    # Ensure other schemes are not passed through
    rm /tmp/xdg-open-output
    ! $SNAPMOUNTDIR/core/current/usr/bin/xdg-open ftp://snapcraft.io
    test ! -e /tmp/xdg-open-output
    ! $SNAPMOUNTDIR/core/current/usr/bin/xdg-open aabbcc
    test ! -e /tmp/xdg-open-output

    systemctl stop --signal=KILL test-dbus-session.scope
    systemctl stop --signal=KILL test-snap-userd.scope

