project: build-snapd

environment:
    PROJECT_PATH: /root/spread

backends:    
    openstack:
        type: openstack
        key: '$(HOST: echo "$OS_CREDENTIALS_AMD64_PS7")'
        plan: shared.medium
        halt-timeout: 2h
        wait-timeout: 5m
        groups: [default]
        proxy: ingress-haproxy.ps7.canonical.com
        cidr-port-rel: [10.151.96.0/21:5000]
        environment:
            SNAPD_USE_PROXY: 'true'
            HTTP_PROXY: 'http://egress.ps7.internal:3128'
            HTTPS_PROXY: 'http://egress.ps7.internal:3128'
            http_proxy: 'http://egress.ps7.internal:3128'
            https_proxy: 'http://egress.ps7.internal:3128'
            no_proxy: '127.0.0.1,127.0.0.53,localhost'
            NO_PROXY: '127.0.0.1,127.0.0.53,localhost'
            NTP_SERVER: 'ntp.ps7.internal'
        systems:
            - ubuntu-22.04-64:
                image: snapd-spread/ubuntu-22.04-64
                workers: 8

    openstack-arm:
        type: openstack
        key: '$(HOST: echo "$OS_CREDENTIALS_ARM64_PS7")'
        plan: shared.large.arm64
        halt-timeout: 2h
        wait-timeout: 5m
        groups: [default]
        proxy: ingress-haproxy.ps7.canonical.com
        cidr-port-rel: [10.151.89.0/24:8000]
        environment:
            SNAPD_USE_PROXY: 'true'
            HTTP_PROXY: 'http://egress.ps7.internal:3128'
            HTTPS_PROXY: 'http://egress.ps7.internal:3128'
            http_proxy: 'http://egress.ps7.internal:3128'
            https_proxy: 'http://egress.ps7.internal:3128'
            no_proxy: '127.0.0.1,127.0.0.53,localhost'
            NO_PROXY: '127.0.0.1,127.0.0.53,localhost'
            NTP_SERVER: 'ntp.ps7.internal'
        systems:
            - ubuntu-24.04-arm-64:
                image: auto-sync/ubuntu-noble-24.04-arm64-server

    testflinger:
        environment:
            TRUST_TEST_KEYS: "false"
        halt-timeout: 3h
        wait-timeout: 2h
        systems:
            - ubuntu-22.04-armhf-rpi3:
                  queue: rpi3b
                  image: https://old-releases.ubuntu.com/releases/jammy/ubuntu-22.04-beta-preinstalled-server-armhf+raspi.img.xz
                  username: ubuntu
                  password: ubuntu

    external:
        type: adhoc
        environment:
            SPREAD_EXTERNAL_ADDRESS: '$(HOST: echo "${SPREAD_EXTERNAL_ADDRESS:-}")'
            HTTP_PROXY: '$(HOST: echo "${HTTP_PROXY:-}")'
            HTTPS_PROXY: '$(HOST: echo "${HTTPS_PROXY:-}")'            
            http_proxy: '$(HOST: echo "${http_proxy:-}")'
            https_proxy: '$(HOST: echo "${https_proxy:-}")'
            NO_PROXY: '$(HOST: echo "${NO_PROXY:-}")'
            no_proxy: '$(HOST: echo "${no_proxy:-}")'
        allocate: |
            ADDRESS $SPREAD_EXTERNAL_ADDRESS
        systems:
            - ubuntu-20.04-armhf:
                  username: root
                  password: ubuntu
            - ubuntu-22.04-armhf:
                  username: root
                  password: ubuntu
            - ubuntu-24.04-armhf:
                  username: root
                  password: ubuntu


path: /root/spread

kill-timeout: 60m

suites:
    tests/:
        summary: Test building snapd in different architectures
        prepare: |
            if [ -n "$HTTPS_PROXY" ]; then
                {
                    echo "HTTPS_PROXY=$HTTPS_PROXY"
                    echo "HTTP_PROXY=$HTTP_PROXY"
                    echo "https_proxy=$HTTPS_PROXY"
                    echo "http_proxy=$HTTP_PROXY"
                    echo "NO_PROXY=$NO_PROXY"
                    echo "no_proxy=$NO_PROXY"
                } >> /etc/environment
            fi
        restore: |
            rm -rf "$PROJECT_PATH"
