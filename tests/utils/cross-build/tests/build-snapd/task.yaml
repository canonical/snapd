summary: Build snap on a specific architecture

details: |
   Verifies that snapd can be built on a specific architecture.

prepare: |
    apt update
    apt install -y git  

    # make sure snapd snap is refreshed
    snap refresh
    snap install yq

    git clone https://github.com/snapcore/snapd.git
    yaml=snapd/build-aux/snap/snapcraft.yaml
    channel="$(yq '.parts.snapd.build-snaps[]' $yaml | awk -F'/' '{print $2"/"$3}')"

    snap install go --classic --channel "$channel"
    snap install snapcraft --classic
    snap install lxd
    lxd waitready
    lxd init --auto

    if [ -n "${https_proxy:-}" ]; then
        lxd.lxc profile set default environment.http_proxy "$http_proxy"
        lxd.lxc profile set default environment.https_proxy "$https_proxy"
        lxd.lxc profile set default environment.no_proxy "$no_proxy"
    fi

execute: |  
    cd snapd
    snapcraft --verbose | tee snapcraft.log
    MATCH "Created snap package snapd_*" < snapcraft.log
