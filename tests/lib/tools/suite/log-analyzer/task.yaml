summary: test for the log analyzer tool

execute: |
    "$TESTSTOOLS"/log-analyzer --help | grep -qE 'usage: log-analyzer \[-h\] \[-c CUT\]'
    "$TESTSTOOLS"/log-analyzer -h | grep -qE 'usage: log-analyzer \[-h\] \[-c CUT\]'
    
    # Check results when the log just contains successful tests
    "$TESTSTOOLS"/log-analyzer all-passed.log.spread -pd none
    TESTS_SUCCESSFUL=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Successful") | .number' spread-results.json)
    test "$TESTS_SUCCESSFUL" = "102"

    # Check results when the log contains failed tests
    "$TESTSTOOLS"/log-analyzer with-failed.log.spread -pd none
    TESTS_SUCCESSFUL=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Successful") | .number' spread-results.json)
    TESTS_FAILED=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Failed") | .number' spread-results.json)
    test "$TESTS_SUCCESSFUL" = "434"
    test "$TESTS_FAILED" = "1"

    # Check results when the log contains failed tests
    "$TESTSTOOLS"/log-analyzer all-aborted.log.spread -pd none
    TESTS_SUCCESSFUL=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Successful") | .number' spread-results.json)
    TESTS_FAILED=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Failed") | .number' spread-results.json)
    TESTS_ABORTED=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Aborted") | .number' spread-results.json)
    test "$TESTS_SUCCESSFUL" = "0"
    test -z "$TESTS_FAILED"
    test "$TESTS_ABORTED" = "505"

    # Check results when the log contains aborted, failed and successful TESTS
    "$TESTSTOOLS"/log-analyzer with-failed-and-aborted.log.spread -pd none
    TESTS_SUCCESSFUL=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Successful") | .number' spread-results.json)
    TESTS_FAILED_TASKS=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Failed")  | select(.level == "tasks") | .number' spread-results.json)
    TESTS_FAILED_TASK=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Failed")  | select(.level == "task") | .number' spread-results.json)
    TESTS_FAILED_PROJECT=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Failed") | select(.level == "project") | .number' spread-results.json)
    TESTS_ABORTED_1=$(jq -r '.[] | select( .type == "result") | select( .result_type == "Aborted") | .number' spread-results.json)
    test "$TESTS_SUCCESSFUL" = "400"
    test "$TESTS_FAILED_TASKS" = "1"
    test "$TESTS_FAILED_TASK" = "1"
    test "$TESTS_FAILED_PROJECT" = "4"
    test "$TESTS_ABORTED" = "24"
