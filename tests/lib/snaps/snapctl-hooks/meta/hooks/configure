#!/bin/sh

test_nonexisting() {
	echo "Getting a configuration value that shouldn't be there"
	if [ "$(snapctl get non-existing 2>&1)" != "" ]; then
		echo "Expected getting a non-existing value to be empty"
		exit 1
	fi
}

test_snapctl_set_foo() {
	echo "Setting foo"
	if ! snapctl set foo=bar; then
		echo "snapctl set unexpectedly failed"
		exit 1
	fi
}

test_snapctl_set_bar_doc() {
  echo "Setting bar document"
  if ! snapctl set bar="{\"a\":{\"aa\":1,\"ab\":2},\"b\":3}"; then
    echo "snapctl set unexpectedly failed"
    exit 1
  fi
}

test_snapctl_get_foo() {
	echo "Getting foo"
	if ! output="$(snapctl get foo)"; then
		echo "Expected snapctl get to be able to retrieve value just set"
		exit 1
	fi

	expected_output="bar"
	if [ "$output" != "$expected_output" ]; then
		echo "Expected output to be '$expected_output', but it was '$output'"
		exit 1
	fi
}

test_get_int_number() {
  echo "Getting int number"
  if ! output="$(snapctl get intnumber)"; then
		echo "Expected snapctl get to be able to retrieve value just set"
		exit 1
	fi
	expected_output="1234567890"
	if [ "$output" != "$expected_output" ]; then
		  echo "Expected output to be '$expected_output', but it was '$output'"
		  exit 1
	fi
  if ! output="$(snapctl get intnumber2)"; then
		  echo "Expected snapctl get to be able to retrieve value just set"
		  exit 1
	fi
	expected_output="\"a\": 9876543210"
	if ! echo "$output" | grep -q -e "$expected_output"; then
		  echo "Expected output to be '$expected_output', but it was '$output'"
		  exit 1
	fi
}

test_snapctl_get_foo_null() {
	  echo "Getting foo"
	  if ! output="$(snapctl get foo)"; then
		    echo "Expected snapctl get to be able to retrieve value just set"
		    exit 1
	  fi

	  expected_output=""
	  if [ "$output" != "$expected_output" ]; then
		    echo "Expected output to be '$expected_output', but it was '$output'"
		    exit 1
	  fi
}

test_exit_one() {
	echo "Failing as requested."
	exit 1
}

command=$(snapctl get command)
case $command in
	"")
		;;
	"test-nonexisting")
		test_nonexisting
		;;
  "test-snapctl-set-bar-doc")
    test_snapctl_set_bar_doc
    ;;
	"test-snapctl-set-foo")
		test_snapctl_set_foo
		;;
	"test-snapctl-get-foo")
		test_snapctl_get_foo
		;;
	"test-snapctl-get-foo-null")
    test_snapctl_get_foo_null
    ;;
	"test-exit-one")
		test_exit_one
		;;
  "test-get-int")
    test_get_int_number
    ;;
	*)
		echo "Invalid command: '$command'"
		exit 1
		;;
esac
