summary: integration tests for log-analyzer tool

# Github actions agents are just running in bionic and focal
systems: [ubuntu-18.04-64, ubuntu-20.04-64]

execute: |
    # Check help
    log-analyzer | MATCH "usage: get-failed-tasks <PARSED-LOG>"
    log-analyzer -h | MATCH "usage: get-failed-tasks <PARSED-LOG>"
    log-analyzer --help | MATCH "usage: get-failed-tasks <PARSED-LOG>"

    # Check parsed log including just failed tests
    test "$(log-analyzer get-failed-tasks spread-results-with-failed.json)" = 1
    test "$(log-analyzer get-aborted-tasks spread-results-with-failed.json)" = 0
    test "$(log-analyzer get-successful-tasks spread-results-with-failed.json)" = 434
    test "$(log-analyzer get-total-tasks spread-results-with-failed.json)" = 435
    log-analyzer list-failed-tasks spread-results-with-failed.json | MATCH "tests.pkgs"
    log-analyzer allow-partial-reexecute spread-results-with-failed.json
    log-analyzer list-reexecute-tasks spread-results-with-failed.json | MATCH "tests.pkgs"

    # Check parsed log with all successful tests
    test "$(log-analyzer get-failed-tasks spread-results-all-successful.json)" = 0
    test "$(log-analyzer get-aborted-tasks spread-results-all-successful.json)" = 0
    test "$(log-analyzer get-successful-tasks spread-results-all-successful.json)" = 434
    test "$(log-analyzer get-total-tasks spread-results-all-successful.json)" = 434
    test -z "$(log-analyzer list-failed-tasks spread-results-all-successful.json)"
    test -z "$(log-analyzer list-failed task prepare spread-results-all-successful.json)"
    test "$(log-analyzer get-failed task prepare spread-results-all-successful.json)" = 0
    test -z "$(log-analyzer list-failed task restore spread-results-all-successful.json)"
    test "$(log-analyzer get-failed task restore spread-results-all-successful.json)" = 0
    test -z "$(log-analyzer list-failed suite prepare spread-results-all-successful.json)"
    test "$(log-analyzer get-failed suite prepare spread-results-all-successful.json)" = 0
    test -z "$(log-analyzer list-failed suite restore spread-results-all-successful.json)"
    test "$(log-analyzer get-failed suite restore spread-results-all-successful.json)" = 0
    test -z "$(log-analyzer list-failed project prepare spread-results-all-successful.json)"
    test "$(log-analyzer get-failed project prepare spread-results-all-successful.json)" = 0
    test -z "$(log-analyzer list-failed project restore spread-results-all-successful.json)"
    test "$(log-analyzer get-failed project restore spread-results-all-successful.json)" = 0
    # shellcheck disable=SC2251
    ! log-analyzer allow-partial-reexecute spread-results-all-successful.json
    test -z "$(log-analyzer list-reexecute-tasks spread-results-all-successful.json)"

    # Check parsed log including just aborted tests
    test "$(log-analyzer get-failed-tasks spread-results-all-aborted.json)" = 0
    test "$(log-analyzer get-aborted-tasks spread-results-all-aborted.json)" = 0
    test "$(log-analyzer get-successful-tasks spread-results-all-aborted.json)" = 0
    test "$(log-analyzer get-total-tasks spread-results-all-aborted.json)" = 0
    test -z "$(log-analyzer list-failed-tasks spread-results-all-aborted.json)"
    # shellcheck disable=SC2251
    ! log-analyzer allow-partial-reexecute spread-results-all-aborted.json
    test -z "$(log-analyzer list-reexecute-tasks spread-results-all-aborted.json)"

    # Check parsed log including failed and aborted tests
    test "$(log-analyzer get-failed-tasks spread-results-with-failed-and-aborted.json)" = 6
    test "$(log-analyzer get-aborted-tasks spread-results-with-failed-and-aborted.json)" = 24 
    test "$(log-analyzer get-successful-tasks spread-results-with-failed-and-aborted.json)" = 400
    test "$(log-analyzer get-total-tasks spread-results-with-failed-and-aborted.json)" = 430
    log-analyzer list-failed-tasks spread-results-with-failed-and-aborted.json | MATCH "interfaces-x11-unix-socket"
    log-analyzer list-failed-tasks spread-results-with-failed-and-aborted.json | NOMATCH "install-sideload"
    # shellcheck disable=SC2251
    ! log-analyzer allow-partial-reexecute spread-results-with-failed-and-aborted.json
    test -z "$(log-analyzer list-reexecute-tasks spread-results-with-failed-and-aborted.json )"

    # Check failed by level and stage
    test "$(log-analyzer list-failed-tasks spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 2
    test "$(log-analyzer list-failed task prepare spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 3
    test "$(log-analyzer get-failed task prepare spread-results-with-all-results.json)" = 3
    test "$(log-analyzer list-failed task restore spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 2
    test "$(log-analyzer get-failed task restore spread-results-with-all-results.json)" = 2
    test "$(log-analyzer list-failed suite prepare spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 1
    test "$(log-analyzer get-failed suite prepare spread-results-with-all-results.json)" = 1
    test "$(log-analyzer list-failed suite restore spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 2
    test "$(log-analyzer get-failed suite restore spread-results-with-all-results.json)" = 2
    test "$(log-analyzer list-failed project prepare spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 1
    test "$(log-analyzer get-failed project prepare spread-results-with-all-results.json)" = 1
    test "$(log-analyzer list-failed project restore spread-results-with-all-results.json | tr ' ' '\n' | wc -l)" = 2
    test "$(log-analyzer get-failed project restore spread-results-with-all-results.json)" = 2
    # shellcheck disable=SC2251
    ! log-analyzer allow-partial-reexecute spread-results-with-all-results.json
    test -z "$(log-analyzer list-reexecute-tasks spread-results-with-all-results.json)"

    # Check the list of tests to re-execute
    test -z "$(log-analyzer list-reexecute-tasks spread-results-with-repeated-and-aborted.json)"
    test -z "$(log-analyzer list-reexecute-tasks spread-results-with-failed-suite-restore.json)"
    test -z "$(log-analyzer list-reexecute-tasks spread-results-with-failed-project-restore.json)"
    test "$(log-analyzer list-reexecute-tasks spread-results-with-repeated.json | tr ' ' '\n' | wc -l)" = 6