# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: Zygmunt Krynicki
project: demo
backends:
    garden:
        type: adhoc
        allocate: |
            # Spread automatically injects /snap/bin to PATH. When we are
            # running from the image-garden snap then SPREAD_HOST_PATH is the
            # original path before such modifications were applied. Snap
            # applications cannot normally run /snap/bin/* entry-points
            # successfully so re-set PATH to the original value, as provided by
            # snapcraft.
            if [ -n "${SPREAD_HOST_PATH-}" ]; then
                PATH="${SPREAD_HOST_PATH}"
            fi

            export QEMU_SMP_OPTION="-smp 2"
            export QEMU_MEM_OPTION="-m 768"

            exec image-garden allocate "$SPREAD_SYSTEM"."${ARCH:=$(uname -m)}"
        discard: |
            # Spread automatically injects /snap/bin to PATH. When we are
            # running from the image-garden snap then SPREAD_HOST_PATH is the
            # original path before such modifications were applied. Snap
            # applications cannot normally run /snap/bin/* entry-points
            # successfully so re-set PATH to the original value, as provided by
            # snapcraft.
            if [ -n "${SPREAD_HOST_PATH-}" ]; then
                PATH="${SPREAD_HOST_PATH}"
            fi

            image-garden discard "$SPREAD_SYSTEM_ADDRESS"
        systems:
            # Ubuntu systems
            - ubuntu-cloud-16.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-18.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-20.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-22.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-24.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-24.10:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-25.04:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-cloud-25.10:
                  username: ubuntu
                  password: ubuntu
            # Ubuntu Core systems
            - ubuntu-core-16:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-core-18:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-core-20:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-core-22:
                  username: ubuntu
                  password: ubuntu
            - ubuntu-core-24:
                  username: ubuntu
                  password: ubuntu
path: /root/plz-run
exclude:
    - .git
    - ".image-garden/*"
    - ./plz-run
prepare: |
    # Spread clobbers the PATH of the system so reload the vanilla value
    . /etc/environment
    # Hey, it was on PATH already ;-)
    go build -o /snap/bin/plz-run
suites:
    tests/:
        summary: Functional tests
